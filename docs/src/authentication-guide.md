# Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹èªè¨¼æ©Ÿèƒ½ã®åŒ…æ‹¬çš„ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ (2025å¹´ç‰ˆ)

> **ğŸ“– èªè¨¼ãƒ»èªå¯ > åŒ…æ‹¬çš„ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹**
> æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€èªè¨¼æ©Ÿèƒ½ã«é–¢ã™ã‚‹åŒ…æ‹¬çš„ãªãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã§ã™ã€‚å„èªè¨¼æ–¹å¼ã®è©³ç´°ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³ã€æœ€æ–°ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŠ€è¡“(PARã€DPoPã€mTLSã€FAPIç­‰)ã€ãƒ¬ã‚¬ã‚·ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ¢ãƒ€ãƒŠã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã‚’ç¶²ç¾…çš„ã«è§£èª¬ã—ã¦ã„ã¾ã™ã€‚

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½ç½®ã¥ã‘

- **åŸºç¤ã‚’å­¦ã¶**: [æ¦‚è¦](auth-basics.md) â†’ [OAuth 2.0 / OIDC](oauth-oidc-basics.md) â†’ [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–](security-practices.md)
- **å®Ÿè£…ã™ã‚‹**: [å®Ÿè£…ã‚¬ã‚¤ãƒ‰](implementation-guide.md)
- **æ·±ãç†è§£ã™ã‚‹**: æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ(åŒ…æ‹¬çš„ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹)

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- **[æ¦‚è¦](auth-basics.md)** - èªè¨¼ãƒ»èªå¯ã®åŸºç¤
- **[OAuth 2.0 / OIDC](oauth-oidc-basics.md)** - ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®è©³ç´°
- **[ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–](security-practices.md)** - è„…å¨ã¨å¯¾ç­–
- **[å®Ÿè£…ã‚¬ã‚¤ãƒ‰](implementation-guide.md)** - Next.js + Spring Boot + Cognito ã®å®Ÿè£…

---

## ç›®æ¬¡

1. [èªè¨¼æ©Ÿèƒ½ã®å½¹å‰²](#èªè¨¼æ©Ÿèƒ½ã®å½¹å‰²)
2. [2025å¹´ã®æœ€æ–°å‹•å‘ã¨ãƒ–ãƒ©ã‚¦ã‚¶äº‹æƒ…](#2025å¹´ã®æœ€æ–°å‹•å‘ã¨ãƒ–ãƒ©ã‚¦ã‚¶äº‹æƒ…)
3. [ä»£è¡¨çš„ãªèªè¨¼å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³](#ä»£è¡¨çš„ãªèªè¨¼å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³)
4. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã®å®Ÿè£…æ–¹é‡](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã®å®Ÿè£…æ–¹é‡)
5. [æœ€æ–°ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–æŠ€è¡“](#æœ€æ–°ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–æŠ€è¡“)
6. [Next.js + Spring Boot + AWS Cognitoæ§‹æˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](#nextjs--spring-boot--aws-cognitoæ§‹æˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹)

---

## èªè¨¼æ©Ÿèƒ½ã®å½¹å‰²

### èªè¨¼(Authentication)ã¨ã¯

èªè¨¼ã¨ã¯ã€**ã€Œã‚ãªãŸã¯èª°ã§ã™ã‹?ã€**ã¨ã„ã†å•ã„ã«ç­”ãˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ¬äººã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

### ä¸»ãªå½¹å‰²

- **æœ¬äººç¢ºèª**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸»å¼µã™ã‚‹èº«å…ƒãŒæ­£ã—ã„ã“ã¨ã‚’ç¢ºèª
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿è­·**: ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‹ã‚‰ã‚·ã‚¹ãƒ†ãƒ ã¨ãƒ‡ãƒ¼ã‚¿ã‚’å®ˆã‚‹
- **ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®åŸºç›¤**: èªè¨¼å¾Œã«é©åˆ‡ãªæ¨©é™ã‚’ä»˜ä¸(èªå¯)
- **ç›£æŸ»è¨¼è·¡**: èª°ãŒã„ã¤ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‹ã‚’è¨˜éŒ²

### èªè¨¼ã¨èªå¯ã®é•ã„

| é …ç›® | èªè¨¼(Authentication) | èªå¯(Authorization) |
|------|---------------------|-------------------|
| å•ã„ | ã€Œã‚ãªãŸã¯èª°?ã€ | ã€Œã‚ãªãŸã¯ä½•ãŒã§ãã‚‹?ã€ |
| ç›®çš„ | èº«å…ƒç¢ºèª | æ¨©é™ç¢ºèª |
| ã‚¿ã‚¤ãƒŸãƒ³ã‚° | ã‚¢ã‚¯ã‚»ã‚¹æ™‚ | ãƒªã‚½ãƒ¼ã‚¹æ“ä½œæ™‚ |
| ä¾‹ | ãƒ­ã‚°ã‚¤ãƒ³ | ç®¡ç†è€…ç”»é¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ |

### é–¢ä¿‚è€…ã¨å½¹å‰²(OAuth/OIDCå‰æ)

- **ãƒ¦ãƒ¼ã‚¶ãƒ¼(ä¸»ä½“)**: èªè¨¼ã‚’å—ã‘ã‚‹äºº
- **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³(ãƒ–ãƒ©ã‚¦ã‚¶/ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒª)
- **èªå¯ã‚µãƒ¼ãƒ/IdP (Identity Provider)**: èªè¨¼ã¨ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œã‚’æ‹…å½“(AWS Cognito, Auth0ç­‰)
- **ãƒªã‚½ãƒ¼ã‚¹ã‚µãƒ¼ãƒ(API)**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã™ã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- **SP/RP (ãƒªãƒ©ã‚¤ãƒ³ã‚°ãƒ‘ãƒ¼ãƒ†ã‚£)**: IdPã‚’ä¿¡é ¼ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å—ã‘å…¥ã‚Œã‚‹å´

---

## 2025å¹´ã®æœ€æ–°å‹•å‘ã¨ãƒ–ãƒ©ã‚¦ã‚¶äº‹æƒ…

### ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookieã®æ®µéšçš„å»ƒæ­¢

2024å¹´ã‹ã‚‰Chromeã‚’ã¯ã˜ã‚ã¨ã™ã‚‹ä¸»è¦ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookieã®æ®µéšçš„å»ƒæ­¢ãŒé€²ã‚“ã§ã„ã¾ã™ã€‚

#### å½±éŸ¿

- âŒ **å¾“æ¥ã®ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥(éš ã—iframe)ãŒä½¿ãˆãªã„**
- âŒ **IdPã®ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookieä¾å­˜SSOãŒå›°é›£ã«**
- âŒ **ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶­æŒãŒåˆ¶é™**

#### å¯¾ç­–

- âœ… **BFF(Backend For Frontend)ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¡ç”¨** â† **2025å¹´ã®ä¸»æµ**
- âœ… **åŒä¸€ã‚µã‚¤ãƒˆCookieé‹ç”¨**
- âœ… **FedCM(Federated Credential Management)ã®æ´»ç”¨** â† Chromeæœ¬æ ¼å°å…¥æ¸ˆã¿
- âœ… **Authorization Code + PKCE ãƒ•ãƒ­ãƒ¼**

### SameSiteå±æ€§ã®å¼·åŒ–

```javascript
// æ¨å¥¨Cookieè¨­å®š
Set-Cookie: session_id=xxx;
  HttpOnly;           // JavaScriptã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯(XSSå¯¾ç­–)
  Secure;             // HTTPSé€šä¿¡ã®ã¿
  SameSite=Strict;    // ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã§é€ä¿¡ã—ãªã„(CSRFå¯¾ç­–)
  Max-Age=86400       // æœ‰åŠ¹æœŸé™
```

### ãã®ä»–ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

- **CSP(Content Security Policy)**: XSSæ”»æ’ƒã‚’é˜²ãHTTPãƒ˜ãƒƒãƒ€ãƒ¼
- **Trusted Types**: DOMæ“ä½œã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã‚’å¼·åˆ¶
- **HSTS**: HTTPSé€šä¿¡ã‚’å¼·åˆ¶

### OAuth 2.1ã¸ã®ç§»è¡Œ

OAuth 2.1ã¯æ¥­ç•Œã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’æ¨™æº–åŒ–ã—ãŸæœ€æ–°ä»•æ§˜ã§ã™ã€‚

#### ä¸»ãªå¤‰æ›´ç‚¹

- âœ… **Authorization Code + PKCE ã‚’æ¨™æº–åŒ–**
- âŒ **Implicit Flow ã¯éæ¨å¥¨(å»ƒæ­¢)**
- âŒ **Resource Owner Password Credentials (ROPC) ã¯éæ¨å¥¨**
- âœ… **ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã®å³æ ¼ãªä¸€è‡´å¿…é ˆ**
- âœ… **state/nonce ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¿…é ˆåŒ–**

---

## ä»£è¡¨çš„ãªèªè¨¼å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã®æ¦‚è¦

ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿æŒã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã®ã¿ã‚’æ¸¡ã™ä¼çµ±çš„ãªæ–¹å¼ã€‚

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã®é€šä¿¡ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant Client as ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant Server as ã‚µãƒ¼ãƒãƒ¼
    participant Store as ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆã‚¢

    Client->>Server: 1. ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±(ID/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰)é€ä¿¡
    Server->>Server: 2. èªè¨¼æˆåŠŸ
    Server->>Store: ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒ»ä¿å­˜
    Server->>Client: 3. Set-Cookie: session_id=xxxxx
    Client->>Server: 4. Cookie: session_id=xxxxx (ä»¥é™ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ)
    Server->>Store: 5. ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å–å¾—
    Store->>Server: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
    Server->>Server: å‡¦ç†å®Ÿè¡Œ
```

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã®ãƒ¡ãƒªãƒƒãƒˆ

- âœ… ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å³åº§ã«ç„¡åŠ¹åŒ–å¯èƒ½
- âœ… å®Ÿè£…ãŒã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„
- âœ… å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚‚å‹•ä½œ
- âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã§å®Œå…¨åˆ¶å¾¡

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

- âŒ ã‚µãƒ¼ãƒãƒ¼ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜é ˜åŸŸãŒå¿…è¦(ãƒ¡ãƒ¢ãƒªã‚„Redis)
- âŒ æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³å…±æœ‰ã®ä»•çµ„ã¿ãŒå¿…è¦
- âŒ CSRFæ”»æ’ƒã¸ã®å¯¾ç­–ãŒå¿…é ˆ
- âŒ ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã§ã®Cookieç®¡ç†ãŒè¤‡é›‘

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã®é©ç”¨ã‚·ãƒ¼ãƒ³

- ç®¡ç†ç”»é¢ã‚„ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãŒé‡è¦ãªå ´åˆ
- ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯(Rails, Django, PHP)ã§ã®å®Ÿè£…

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã®æ³¨æ„ãƒã‚¤ãƒ³ãƒˆ

- **CSRFå¯¾ç­–**: CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å®Ÿè£…å¿…é ˆ
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šæ”»æ’ƒ**: ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å†ç”Ÿæˆ
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: é©åˆ‡ãªæœ‰åŠ¹æœŸé™è¨­å®š(ã‚¢ã‚¤ãƒ‰ãƒ«ã¨çµ¶å¯¾ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®ä½µç”¨)
- **Secure/HttpOnly/SameSiteå±æ€§**: Cookieã®é©åˆ‡ãªè¨­å®š

#### Cookieè¨­å®šä¾‹

```javascript
// Express.js
app.use(session({
  name: 'sessionId',
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: true,        // HTTPSå¿…é ˆ
    httpOnly: true,      // XSSå¯¾ç­–
    sameSite: 'strict',  // CSRFå¯¾ç­–
    maxAge: 3600000      // 1æ™‚é–“
  }
}));
```

---

### 2. ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼(JWT)

#### ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã®æ¦‚è¦

ã‚µãƒ¼ãƒãƒ¼ãŒç½²åä»˜ããƒˆãƒ¼ã‚¯ãƒ³(JWT: JSON Web Token)ã‚’ç™ºè¡Œã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ä¿æŒã™ã‚‹æ–¹å¼ã€‚

#### JWTã®æ§‹é€ 

```text
Header.Payload.Signature
eyJhbGc...(Base64).eyJ1c2Vy...(Base64).SflKxwRJ...(ç½²å)
```

- **Header**: ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ æƒ…å ±(HS256, RS256ãªã©)
- **Payload**: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€æœ‰åŠ¹æœŸé™ãªã©
- **Signature**: æ”¹ã–ã‚“æ¤œçŸ¥ç”¨ã®ç½²å

#### ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã®é€šä¿¡ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant Client as ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant Server as ã‚µãƒ¼ãƒãƒ¼

    Client->>Server: 1. ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±é€ä¿¡
    Server->>Server: 2. èªè¨¼æˆåŠŸãƒ»JWTç”Ÿæˆ(ç½²å)
    Server->>Client: 3. { "access_token": "eyJhbGc..." }
    Client->>Client: 4. JWTã‚’LocalStorage/SessionStorageã«ä¿å­˜
    Client->>Server: 5. Authorization: Bearer eyJhbGc...
    Server->>Server: 6. JWTæ¤œè¨¼(ç½²åç¢ºèªã€æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯)
    Server->>Server: å‡¦ç†å®Ÿè¡Œ
```

#### ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã®ãƒ¡ãƒªãƒƒãƒˆ

- âœ… ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹(ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿æŒä¸è¦)
- âœ… æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãŒå®¹æ˜“
- âœ… ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“ã§ã®èªè¨¼æƒ…å ±å…±æœ‰ãŒç°¡å˜
- âœ… ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã¨ã®ç›¸æ€§ãŒè‰¯ã„
- âœ… CORSå¯¾å¿œãŒå®¹æ˜“

#### ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

- âŒ ãƒˆãƒ¼ã‚¯ãƒ³ã®å³åº§ãªç„¡åŠ¹åŒ–ãŒå›°é›£
- âŒ ãƒˆãƒ¼ã‚¯ãƒ³ã‚µã‚¤ã‚ºãŒå¤§ãã„(æ¯å›é€ä¿¡ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰)
- âŒ XSSæ”»æ’ƒã§ãƒˆãƒ¼ã‚¯ãƒ³ãŒç›—ã¾ã‚Œã‚‹ãƒªã‚¹ã‚¯
- âŒ ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†ãŒå¿…è¦

#### ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã®é©ç”¨ã‚·ãƒ¼ãƒ³

- SPA(Single Page Application) + APIã‚µãƒ¼ãƒãƒ¼æ§‹æˆ
- ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API
- è¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹é–“ã§ã®èªè¨¼æƒ…å ±å…±æœ‰

#### ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ã®æ³¨æ„ãƒã‚¤ãƒ³ãƒˆ

- **ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¿å­˜å ´æ‰€**: LocalStorage(XSSæ³¨æ„)ã€HttpOnly Cookieæ¨å¥¨
- **æœ‰åŠ¹æœŸé™**: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯çŸ­ã‚(15åˆ†ã€œ1æ™‚é–“)
- **ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³**: é•·æœŸé–“æœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã§å†ç™ºè¡Œ
- **ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**: ä½¿ã„æ¨ã¦ï¼‹å†åˆ©ç”¨æ¤œçŸ¥ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
- **ç½²åã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: RS256/ES256(å…¬é–‹éµæ–¹å¼)æ¨å¥¨ã€HS256ã¯å…±é€šéµ
- **ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ**: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–ãƒªã‚¹ãƒˆã«è¿½åŠ 
- **ãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°**: DPoP/mTLSã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ/æ¥ç¶šã«ãƒã‚¤ãƒ³ãƒ‰

#### ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜å ´æ‰€ã®æ¯”è¼ƒ(2025å¹´ç‰ˆ)

| ä¿å­˜å ´æ‰€ | XSSè€æ€§ | CSRFè€æ€§ | ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ™‚ã®æ¶ˆå¤± | æ¨å¥¨åº¦ |
|---------|---------|----------|---------------------|--------|
| **HttpOnly Cookie** | âœ… é«˜ | âš ï¸ è¦å¯¾ç­– | âŒ ãªã— | **ğŸŒŸ æœ€æ¨å¥¨** |
| **ãƒ¡ãƒ¢ãƒª(Stateç®¡ç†)** | âœ… é«˜ | âœ… é«˜ | âŒ ã‚ã‚Š | âœ… æ¨å¥¨ |
| SessionStorage | âŒ ä½ | âœ… é«˜ | âŒ ã‚ã‚Š | âš ï¸ æ¡ä»¶ä»˜ã |
| LocalStorage | âŒ ä½ | âœ… é«˜ | âœ… ãªã— | âŒ éæ¨å¥¨ |

**2025å¹´ã®æ¨å¥¨**: BFFãƒ‘ã‚¿ãƒ¼ãƒ³(å¾Œè¿°)ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚µãƒ¼ãƒãƒ¼å´ç®¡ç†ã€ã¾ãŸã¯HttpOnly Cookie + ãƒ¡ãƒ¢ãƒªã®çµ„ã¿åˆã‚ã›

---

### 3. OAuth 2.0 / OpenID Connect

#### OAuth/OIDCã®æ¦‚è¦

å¤–éƒ¨ã®èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼(Google, GitHub, AWS Cognitoç­‰)ã‚’åˆ©ç”¨ã—ãŸèªè¨¼æ–¹å¼ã€‚

#### ä¸»è¦ãªæ¦‚å¿µ

- **èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼(IdP)**: èªè¨¼ã‚’æä¾›ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹
- **ãƒªã‚½ãƒ¼ã‚¹ã‚ªãƒ¼ãƒŠãƒ¼**: ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼
- **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**: ã‚ãªãŸã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- **èªå¯ã‚µãƒ¼ãƒãƒ¼**: ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ã‚µãƒ¼ãƒãƒ¼

#### é€šä¿¡ãƒ•ãƒ­ãƒ¼(èªå¯ã‚³ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼)

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Client as ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant IdP as èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼(IdP)
    participant API as APIã‚µãƒ¼ãƒãƒ¼

    Client->>IdP: 1. èªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ(redirect)
    IdP->>User: 2. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
    User->>IdP: 3. èªè¨¼æƒ…å ±å…¥åŠ›ã€è¨±å¯
    IdP->>Client: 4. èªå¯ã‚³ãƒ¼ãƒ‰ç™ºè¡Œ(callbackã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ)
    Client->>IdP: 5. èªå¯ã‚³ãƒ¼ãƒ‰ + ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆé€ä¿¡
    IdP->>Client: 6. ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ + IDãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ
    Client->>API: 7. ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã§ä¿è­·ã•ã‚ŒãŸAPIã¸ã‚¢ã‚¯ã‚»ã‚¹
```

#### OAuth/OIDCã®ãƒ¡ãƒªãƒƒãƒˆ

- âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†ä¸è¦(IdPãŒç®¡ç†)
- âœ… MFA(å¤šè¦ç´ èªè¨¼)ãªã©ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½
- âœ… ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè£…ãŒå®¹æ˜“
- âœ… æ¨™æº–ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ç›¸äº’é‹ç”¨æ€§ãŒé«˜ã„
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã®æ‰‹é–“å‰Šæ¸›

#### OAuth/OIDCã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

- âŒ å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ä¾å­˜
- âŒ å®Ÿè£…ãŒè¤‡é›‘
- âŒ IdPã®ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã®å½±éŸ¿ã‚’å—ã‘ã‚‹
- âŒ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã‚„GDPRå¯¾å¿œãŒå¿…è¦

#### OAuth/OIDCã®é©ç”¨ã‚·ãƒ¼ãƒ³

- B2Cã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³(ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘)
- ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã‚’æä¾›ã—ãŸã„å ´åˆ
- ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºSSOãŒå¿…è¦ãªå ´åˆ
- èªè¨¼åŸºç›¤ã‚’è‡ªå‰ã§æŒã¡ãŸããªã„å ´åˆ

#### OAuth 2.0ã®ãƒ•ãƒ­ãƒ¼é¸æŠ(2025å¹´ç‰ˆ)

| ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ | æ¨å¥¨ãƒ•ãƒ­ãƒ¼ | ç†ç”± |
|------------|----------|------|
| **ãƒ–ãƒ©ã‚¦ã‚¶(SPA)** | Authorization Code + PKCE | Implicitå»ƒæ­¢ã€ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookieå•é¡Œã«å¯¾å¿œ |
| **ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°** | Authorization Code | ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†å¯èƒ½ã€ã‚»ã‚­ãƒ¥ã‚¢ |
| **ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒª** | Authorization Code + PKCE | ã‚·ã‚¹ãƒ†ãƒ ãƒ–ãƒ©ã‚¦ã‚¶ä½¿ç”¨ã€åŸ‹ã‚è¾¼ã¿WebViewç¦æ­¢ |
| **ãƒ†ãƒ¬ãƒ“/IoT** | Device Authorization Grant | ãƒ‡ãƒã‚¤ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ |
| **M2M(ã‚µãƒ¼ãƒãƒ¼é–“)** | Client Credentials | mTLS/private_key_jwtæ¨å¥¨ |

#### OAuth/OIDCã®æ³¨æ„ãƒã‚¤ãƒ³ãƒˆ

- âŒ **Implicit Flow ã¯ä½¿ç”¨ç¦æ­¢**(OAuth 2.1ã§å»ƒæ­¢)
- âŒ **Resource Owner Password Credentials (ROPC) ã‚‚éæ¨å¥¨**
- âœ… **Authorization Code + PKCE**: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›(ã‚»ã‚­ãƒ¥ã‚¢)
- âœ… **PKCE**: ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚„SPAã§ã®å¿…é ˆæ‹¡å¼µã€èªå¯ã‚³ãƒ¼ãƒ‰æ¨ªå–ã‚Šæ”»æ’ƒã‚’é˜²æ­¢
- âœ… **state ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**: CSRFå¯¾ç­–(å¿…é ˆ)
- âœ… **nonce**: ãƒªãƒ—ãƒ¬ã‚¤ã‚¢ã‚¿ãƒƒã‚¯å¯¾ç­–(OIDCä½¿ç”¨æ™‚)
- âœ… **ã‚¹ã‚³ãƒ¼ãƒ—ç®¡ç†**: å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿è¦æ±‚
- âœ… **ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã®å³æ ¼ãªä¸€è‡´**: å®Œå…¨ä¸€è‡´ã®ã¿è¨±å¯(ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ç¦æ­¢)

---

### 4. å¤šè¦ç´ èªè¨¼(MFA: Multi-Factor Authentication)

#### MFAã®æ¦‚è¦

è¤‡æ•°ã®èªè¨¼è¦ç´ ã‚’çµ„ã¿åˆã‚ã›ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã™ã‚‹æ–¹å¼ã€‚2025å¹´ç¾åœ¨ã€**ãƒ‘ã‚¹ã‚­ãƒ¼(WebAuthn/FIDO2)** ãŒä¸»æµåŒ–ã€‚

#### èªè¨¼ã®3è¦ç´ 

1. **çŸ¥è­˜è¦ç´ **: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€PINã‚³ãƒ¼ãƒ‰
2. **æ‰€æŒè¦ç´ **: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã€ãƒ‘ã‚¹ã‚­ãƒ¼
3. **ç”Ÿä½“è¦ç´ **: æŒ‡ç´‹ã€é¡”èªè¨¼

#### MFAã®å®Ÿè£…æ–¹å¼(2025å¹´ç‰ˆæ¨å¥¨é †)

| æ–¹å¼ | ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°è€æ€§ | UX | æ¨å¥¨åº¦ | å‚™è€ƒ |
|------|----------------|-----|--------|------|
| **WebAuthn/ãƒ‘ã‚¹ã‚­ãƒ¼** | âœ… é«˜ | âœ… è‰¯å¥½ | **ğŸŒŸ æœ€æ¨å¥¨** | ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ èªè¨¼å™¨/ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ |
| **TOTP** | âš ï¸ ä¸­ | âœ… è‰¯å¥½ | âœ… æ¨å¥¨ | Google Authenticatorç­‰ |
| **ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥** | âœ… é«˜ | âœ… è‰¯å¥½ | âœ… æ¨å¥¨ | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±è¡¨ç¤ºå¿…é ˆ |
| **SMS/éŸ³å£°** | âŒ ä½ | âš ï¸ å¯ | âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ | SIMã‚¹ãƒ¯ãƒƒãƒ”ãƒ³ã‚°æ”»æ’ƒã«è„†å¼± |

#### ãƒ‘ã‚¹ã‚­ãƒ¼(Passkeys)ã®åˆ©ç‚¹

- âœ… **ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°è€æ€§**: ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã§å½ã‚µã‚¤ãƒˆã§ã¯ä½¿ç”¨ä¸å¯
- âœ… **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸è¦**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹èªè¨¼å®Ÿç¾
- âœ… **ç”Ÿä½“èªè¨¼**: æŒ‡ç´‹ãƒ»é¡”èªè¨¼ã§ä¾¿åˆ©
- âœ… **ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ **: ãƒ‡ãƒã‚¤ã‚¹é–“åŒæœŸå¯èƒ½
- âœ… **æ¥­ç•Œæ¨™æº–**: Apple, Google, MicrosoftãŒæ¨é€²

#### å®Ÿè£…ä¾‹(WebAuthn)

```javascript
// ç™»éŒ²æ™‚
const credential = await navigator.credentials.create({
  publicKey: {
    challenge: new Uint8Array(32), // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—
    rp: { name: "Example Corp", id: "example.com" },
    user: {
      id: new Uint8Array(16),
      name: "user@example.com",
      displayName: "User Name"
    },
    pubKeyCredParams: [
      { type: "public-key", alg: -7 },  // ES256
      { type: "public-key", alg: -257 } // RS256
    ],
    authenticatorSelection: {
      authenticatorAttachment: "platform", // ç”Ÿä½“èªè¨¼
      userVerification: "required"
    }
  }
});

// èªè¨¼æ™‚
const assertion = await navigator.credentials.get({
  publicKey: {
    challenge: new Uint8Array(32),
    rpId: "example.com",
    userVerification: "required"
  }
});
```

#### ãƒªã‚¹ã‚¯ãƒ™ãƒ¼ã‚¹/ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–èªè¨¼

ãƒ­ã‚°ã‚¤ãƒ³ã”ã¨ã«ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’è¡Œã„ã€MFAã®è¦æ±‚ã‚’å‹•çš„ã«åˆ¶å¾¡:

- **ä½ãƒªã‚¹ã‚¯**: MFAã‚¹ã‚­ãƒƒãƒ—(ä¿¡é ¼æ¸ˆã¿ãƒ‡ãƒã‚¤ã‚¹ã€é€šå¸¸ã®å ´æ‰€)
- **ä¸­ãƒªã‚¹ã‚¯**: TOTP/ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥è¦æ±‚
- **é«˜ãƒªã‚¹ã‚¯**: WebAuthnå¿…é ˆã€ã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚¹ãƒ–ãƒ­ãƒƒã‚¯

è©•ä¾¡è¦ç´ :

- IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã€åœ°ç†çš„ä½ç½®
- ãƒ‡ãƒã‚¤ã‚¹ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ
- è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³(æ™‚é–“å¸¯ã€æ“ä½œé€Ÿåº¦ç­‰)
- è„…å¨ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ã‚¹é€£æº

#### ã‚¹ãƒ†ãƒƒãƒ—ã‚¢ãƒƒãƒ—èªè¨¼

é‡è¦æ“ä½œæ™‚ã«è¿½åŠ èªè¨¼ã‚’è¦æ±‚:

```javascript
// é«˜é¡é€é‡‘æ™‚ãªã©
if (amount > 10000) {
  await requireMFA(); // è¿½åŠ èªè¨¼
}
```

#### æ³¨æ„ãƒã‚¤ãƒ³ãƒˆ

- âš ï¸ SMSèªè¨¼ã¯SIMã‚¹ãƒ¯ãƒƒãƒ”ãƒ³ã‚°æ”»æ’ƒã®ãƒªã‚¹ã‚¯ã‚ã‚Š(ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨é€”ã®ã¿)
- âœ… TOTPã€WebAuthnãŒã‚ˆã‚Šå®‰å…¨
- âœ… ãƒªã‚«ãƒãƒªãƒ¼ã‚³ãƒ¼ãƒ‰/ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èªè¨¼å™¨ã®æä¾›ãŒå¿…é ˆ
- âœ… MFAç–²åŠ´æ”»æ’ƒå¯¾ç­–: ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°è¡¨ç¤º
- âœ… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚«ãƒãƒªãƒ¼ãƒ•ãƒ­ãƒ¼ã®æ…é‡ãªè¨­è¨ˆ

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã®å®Ÿè£…æ–¹é‡

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯(ä¸€æ°—é€šè²«å®Ÿè£…)

#### ãƒ‘ã‚¿ãƒ¼ãƒ³1ã®æ§‹æˆä¾‹

```mermaid
graph TD
    Browser[ãƒ–ãƒ©ã‚¦ã‚¶] <-->|HTTP/HTTPS| NextJS[Next.js SSR + API Routes]
    NextJS --> DB[ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹]
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³1ã®ç‰¹å¾´

- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒåŒä¸€ã‚µãƒ¼ãƒãƒ¼ä¸Šã§å‹•ä½œ
- Next.jsã®API Routesã‚„Server Actionsã§å®Œçµ
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãŒã‚·ãƒ³ãƒ—ãƒ«

#### ãƒ‘ã‚¿ãƒ¼ãƒ³1ã®èªè¨¼å®Ÿè£…ã®æ¨å¥¨æ–¹å¼

##### ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼ãŒæ¨å¥¨

ç†ç”±:

- åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãªã®ã§Cookieç®¡ç†ãŒç°¡å˜
- Next.jsã®Middlewareã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼ãŒå®¹æ˜“
- NextAuthã‚„Auth.jsãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå……å®Ÿ

#### å®Ÿè£…ä¾‹(NextAuthä½¿ç”¨)

```javascript
// pages/api/auth/[...nextauth].js
import NextAuth from 'next-auth';
import CredentialsProvider from 'next-auth/providers/credentials';

export default NextAuth({
  providers: [
    CredentialsProvider({
      credentials: {
        email: { label: "Email", type: "text" },
        password: { label: "Password", type: "password" }
      },
      async authorize(credentials) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯
        const user = await validateUser(credentials);
        if (user) {
          return user;
        }
        return null;
      }
    })
  ],
  session: {
    strategy: "jwt", // or "database"
  },
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.id = user.id;
        token.role = user.role;
      }
      return token;
    },
    async session({ session, token }) {
      session.user.id = token.id;
      session.user.role = token.role;
      return session;
    }
  }
});

// middleware.js
import { withAuth } from "next-auth/middleware";

export default withAuth({
  callbacks: {
    authorized({ token }) {
      return !!token;
    },
  },
});

export const config = { matcher: ["/dashboard/:path*"] };
```

#### æ³¨æ„ãƒã‚¤ãƒ³ãƒˆ

- âœ… **CSRFå¯¾ç­–**: ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒè‡ªå‹•å¯¾å¿œ(NextAuthãªã©)
- âœ… **ã‚»ã‚­ãƒ¥ã‚¢ãªCookie**: HttpOnly, Secure, SameSiteå±æ€§è¨­å®š
- âœ… **ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°**: åˆæœŸè¡¨ç¤ºæ™‚ã«èªè¨¼çŠ¶æ…‹ã‚’åæ˜ 
- âš ï¸ **APIãƒ«ãƒ¼ãƒˆã®ä¿è­·**: å„API Routeã§èªè¨¼ãƒã‚§ãƒƒã‚¯
- âš ï¸ **ç’°å¢ƒå¤‰æ•°ç®¡ç†**: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã®é©åˆ‡ãªç®¡ç†

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: SPA + APIã‚µãƒ¼ãƒãƒ¼(åˆ†é›¢æ§‹æˆ)

#### æ§‹æˆä¾‹

```mermaid
graph TD
    Browser[ãƒ–ãƒ©ã‚¦ã‚¶ React/Vue] <-->|HTTP/HTTPS| API[APIã‚µãƒ¼ãƒãƒ¼ Spring Boot/Node.js]
    API --> DB[ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹]
```

#### ç‰¹å¾´

- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒåˆ¥ã‚µãƒ¼ãƒãƒ¼(åˆ¥ãƒ‰ãƒ¡ã‚¤ãƒ³)
- CORSã®è€ƒæ…®ãŒå¿…è¦
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦é…ä¿¡å¯èƒ½

#### èªè¨¼å®Ÿè£…ã®æ¨å¥¨æ–¹å¼(2025å¹´ç‰ˆ)

**ç¬¬ä¸€é¸æŠ: BFF(Backend For Frontend)ãƒ‘ã‚¿ãƒ¼ãƒ³** ğŸŒŸ

BFFã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®é–“ã«å°‚ç”¨ã®ä¸­é–“å±¤ã‚’ç½®ããƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

```mermaid
graph LR
    Browser[ãƒ–ãƒ©ã‚¦ã‚¶] -->|Cookie| BFF[Next.js BFF]
    BFF -->|Bearer Token| API[Spring Boot API]
    BFF -->|OAuth| IdP[AWS Cognito]
```

**BFFã®åˆ©ç‚¹**:

- âœ… ãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒ–ãƒ©ã‚¦ã‚¶ã«éœ²å‡ºã—ãªã„(XSSå¯¾ç­–)
- âœ… ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookieå•é¡Œã‚’å›é¿
- âœ… CORSè¨­å®šãŒã‚·ãƒ³ãƒ—ãƒ«
- âœ… ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã§åˆ¶å¾¡
- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¢ƒç•ŒãŒæ˜ç¢º

**ä»£æ›¿æ¡ˆ: Authorization Code + PKCE (SPAã‹ã‚‰ç›´æ¥)**

BFFãŒä½¿ãˆãªã„å ´åˆã®é¸æŠè‚¢:

- ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ¡ãƒ¢ãƒª(Reactã‚¹ãƒ†ãƒ¼ãƒˆç­‰)ã«ä¿æŒ
- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã¯HttpOnly Cookieã«ä¿å­˜
- ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¨çŸ­å¯¿å‘½åŒ–å¿…é ˆ
- âŒ LocalStorage/SessionStorageã¯é¿ã‘ã‚‹

---

#### å®Ÿè£…ä¾‹1: BFFãƒ‘ã‚¿ãƒ¼ãƒ³(Next.js + Spring Boot)

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´(Next.js BFF)**

```javascript
// app/api/users/profile/route.ts (Next.js 13+ App Router)
import { getServerSession } from 'next-auth';
import { authOptions } from '@/app/api/auth/[...nextauth]/route';

export async function GET() {
  const session = await getServerSession(authOptions);

  if (!session) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // Spring Boot APIã«ãƒ—ãƒ­ã‚­ã‚·
  const response = await fetch(`${process.env.API_BASE_URL}/users/profile`, {
    headers: {
      'Authorization': `Bearer ${session.idToken}`,
      'Content-Type': 'application/json',
    },
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
    next: { revalidate: 60 }
  });

  if (!response.ok) {
    return Response.json({ error: 'API Error' }, { status: response.status });
  }

  const data = await response.json();
  return Response.json(data);
}

// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´
// app/dashboard/page.tsx
'use client';
import { useEffect, useState } from 'react';

export default function Dashboard() {
  const [profile, setProfile] = useState(null);

  useEffect(() => {
    // BFFçµŒç”±ã§APIã«ã‚¢ã‚¯ã‚»ã‚¹(Cookieã¯è‡ªå‹•é€ä¿¡)
    fetch('/api/users/profile')
      .then(res => res.json())
      .then(data => setProfile(data));
  }, []);

  return <div>Welcome {profile?.name}</div>;
}
```

---

#### å®Ÿè£…ä¾‹2: SPAç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹(React + Spring Boot)

**âš ï¸ BFFãŒä½¿ãˆãªã„å ´åˆã®ã¿ä½¿ç”¨**

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´(React)**

```javascript
// authService.js
export const login = async (email, password) => {
  const response = await fetch('https://api.example.com/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  });

  const data = await response.json();

  // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
  localStorage.setItem('accessToken', data.accessToken);
  localStorage.setItem('refreshToken', data.refreshToken);

  return data;
};

// axiosã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨­å®š
import axios from 'axios';

const apiClient = axios.create({
  baseURL: 'https://api.example.com',
});

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼
apiClient.interceptors.request.use((config) => {
  const token = localStorage.getItem('accessToken');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼(ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥)
apiClient.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;

    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;

      const refreshToken = localStorage.getItem('refreshToken');
      const response = await axios.post('https://api.example.com/auth/refresh', {
        refreshToken
      });

      const { accessToken } = response.data;
      localStorage.setItem('accessToken', accessToken);

      originalRequest.headers.Authorization = `Bearer ${accessToken}`;
      return apiClient(originalRequest);
    }

    return Promise.reject(error);
  }
);
```

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´(Spring Boot)**

```java
// SecurityConfig.java
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf().disable() // JWTä½¿ç”¨æ™‚ã¯CSRFç„¡åŠ¹åŒ–
            .cors().configurationSource(corsConfigurationSource())
            .and()
            .sessionManagement()
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS) // ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹
            .and()
            .authorizeHttpRequests()
                .requestMatchers("/auth/login", "/auth/register").permitAll()
                .anyRequest().authenticated()
            .and()
            .addFilterBefore(jwtAuthenticationFilter(),
                           UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Arrays.asList("https://frontend.example.com"));
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE"));
        configuration.setAllowedHeaders(Arrays.asList("*"));
        configuration.setAllowCredentials(true);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
}

// JwtAuthenticationFilter.java
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Autowired
    private JwtTokenProvider jwtTokenProvider;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain) throws ServletException, IOException {

        String token = extractTokenFromRequest(request);

        if (token != null && jwtTokenProvider.validateToken(token)) {
            Authentication auth = jwtTokenProvider.getAuthentication(token);
            SecurityContextHolder.getContext().setAuthentication(auth);
        }

        filterChain.doFilter(request, response);
    }

    private String extractTokenFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (bearerToken != null && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}
```

#### æ³¨æ„ãƒã‚¤ãƒ³ãƒˆ

**1. ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜å ´æ‰€ã®é¸æŠ(2025å¹´ç‰ˆ)**

| ä¿å­˜å ´æ‰€ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ | æ¨å¥¨åº¦ |
|---------|---------|----------|--------|
| HttpOnly Cookie | XSSæ”»æ’ƒã«å¼·ã„ | CSRFå¯¾ç­–å¿…è¦ | âœ… é«˜ |
| ãƒ¡ãƒ¢ãƒª(Stateç®¡ç†) | æœ€ã‚‚ã‚»ã‚­ãƒ¥ã‚¢ | ãƒªãƒ­ãƒ¼ãƒ‰ã§æ¶ˆå¤± | âœ… é«˜(çŸ­å¯¿å‘½ãƒˆãƒ¼ã‚¯ãƒ³) |
| SessionStorage | ã‚¿ãƒ–æ¯ã«ç‹¬ç«‹ | XSSè„†å¼±ã€ã‚¿ãƒ–é–‰ã˜ã‚‹ã¨æ¶ˆå¤± | âš ï¸ ä½ |
| LocalStorage | å®Ÿè£…ç°¡å˜ã€å®¹é‡å¤§ | XSSè„†å¼±ã€æ°¸ç¶šåŒ– | âŒ **ä½¿ç”¨ç¦æ­¢** |

**2025å¹´ã®æ¨å¥¨æˆ¦ç•¥**:

- **BFFãƒ‘ã‚¿ãƒ¼ãƒ³**: ãƒˆãƒ¼ã‚¯ãƒ³ã‚’Next.jsç­‰ã®ã‚µãƒ¼ãƒãƒ¼å´ã§ç®¡ç†(æœ€æ¨å¥¨)
- **SPAç›´æ¥**: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ¡ãƒ¢ãƒªã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã¯HttpOnly Cookie

**2. ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**

```javascript
// ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½¿ã„æ¨ã¦æˆ¦ç•¥
const refreshAccessToken = async (oldRefreshToken) => {
  const response = await fetch('/auth/refresh', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ refreshToken: oldRefreshToken })
  });

  const { accessToken, refreshToken: newRefreshToken } = await response.json();

  // æ–°ã—ã„ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã§å¤ã„ã‚‚ã®ã‚’ç½®ãæ›ãˆ
  httpOnlyCookie.set('refreshToken', newRefreshToken);

  return accessToken;
};

// å†åˆ©ç”¨æ¤œçŸ¥(ã‚µãƒ¼ãƒãƒ¼å´)
if (isRefreshTokenReused(token)) {
  // ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚¡ãƒŸãƒªãƒ¼å…¨ä½“ã‚’ç„¡åŠ¹åŒ–(ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¾µå®³ã®å¯èƒ½æ€§)
  revokeAllTokensForUser(userId);
  return 401;
}
```

**3. CORSè¨­å®š**

```java
// é©åˆ‡ãªCORSè¨­å®š
configuration.setAllowedOrigins(Arrays.asList("https://your-frontend.com"));
// âŒ ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰(*)ã¯AllowCredentials=trueã¨ä½µç”¨ä¸å¯
configuration.setAllowCredentials(true);
```

**3. ãƒˆãƒ¼ã‚¯ãƒ³è¨­è¨ˆ(2025å¹´ç‰ˆ)**

```yaml
ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³:
  æœ‰åŠ¹æœŸé™: 15åˆ†ã€œ1æ™‚é–“(çŸ­å‘½åŒ–)
  ä¿å­˜å ´æ‰€: ãƒ¡ãƒ¢ãƒªã¾ãŸã¯BFFç®¡ç†
  ç”¨é€”: APIèªè¨¼
  å½¢å¼: JWT(ç½²åã‚ã‚Š)ã¾ãŸã¯Opaque Token

ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³:
  æœ‰åŠ¹æœŸé™: 7ã€œ30æ—¥
  ä¿å­˜å ´æ‰€: HttpOnly Cookie ã¾ãŸã¯ BFFç®¡ç†
  ç”¨é€”: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å†ç™ºè¡Œ
  ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³: ä½¿ã„æ¨ã¦ + å†åˆ©ç”¨æ¤œçŸ¥

IDãƒˆãƒ¼ã‚¯ãƒ³(OIDC):
  æœ‰åŠ¹æœŸé™: 1æ™‚é–“
  ç”¨é€”: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
  æ¤œè¨¼: issuer/audience/nonceå¿…é ˆ
```

**4. ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æˆ¦ç•¥**

- ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³: çŸ­å‘½(15åˆ†ã€œ1æ™‚é–“)
- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³: é•·å‘½(7æ—¥ã€œ30æ—¥)
- è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…

**4. XSSå¯¾ç­–**

- Content Security Policy(CSP)ã®è¨­å®š
- DOMPurifyãªã©ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨
- ä¿¡é ¼ã§ããªã„å…¥åŠ›å€¤ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—

**5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼**

```java
http.headers()
    .xssProtection()
    .contentSecurityPolicy("default-src 'self'")
    .and()
    .frameOptions().deny()
    .httpStrictTransportSecurity().maxAgeInSeconds(31536000);
```

---

## æœ€æ–°ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–æŠ€è¡“

### 1. PAR (Pushed Authorization Requests)

#### æ¦‚è¦

èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’äº‹å‰ã«èªå¯ã‚µãƒ¼ãƒãƒ¼ã¸ãƒ—ãƒƒã‚·ãƒ¥ã—ã€æ”¹ã–ã‚“ã‚„æ¼ãˆã„ã‚’é˜²ãæŠ€è¡“ã€‚

#### å‹•ä½œãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant Client
    participant AS as èªå¯ã‚µãƒ¼ãƒãƒ¼

    Client->>AS: 1. POST /par (èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ—ãƒƒã‚·ãƒ¥)
    AS->>Client: 2. request_uriè¿”å´
    Client->>AS: 3. èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ(request_uriä½¿ç”¨)
    AS->>Client: 4. èªå¯ã‚³ãƒ¼ãƒ‰ç™ºè¡Œ
```

#### ãƒ¡ãƒªãƒƒãƒˆ

- âœ… URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ”¹ã–ã‚“é˜²æ­¢
- âœ… ãƒ–ãƒ©ã‚¦ã‚¶å±¥æ­´ã‹ã‚‰ã®æƒ…å ±æ¼ãˆã„é˜²æ­¢
- âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚µã‚¤ã‚ºåˆ¶é™ã®å›é¿

### 2. JAR/JARM (JWT-Secured Authorization Request/Response Mode)

#### JAR (JWT-Secured Authorization Request)

èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’JWTåŒ–ã—ã¦ç½²å:

```javascript
// èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’JWTåŒ–
const request = jwt.sign({
  response_type: 'code',
  client_id: 'xxx',
  redirect_uri: 'https://app.example.com/callback',
  scope: 'openid profile',
  state: 'xyz',
  nonce: 'abc'
}, privateKey, { algorithm: 'RS256' });

// èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸
location.href = `${authServer}/authorize?request=${request}`;
```

#### JARM (JWT-Secured Authorization Response Mode)

èªå¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’JWTåŒ–ã—ã¦æ”¹ã–ã‚“æ¤œçŸ¥:

- ãƒŸãƒƒã‚¯ã‚¹ã‚¢ãƒƒãƒ—æ”»æ’ƒ(ç•°ãªã‚‹ASã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ··å…¥)ã‚’é˜²æ­¢
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å®Œå…¨æ€§ä¿è¨¼

### 3. DPoP (Demonstrating Proof-of-Possession)

#### æ¦‚è¦

ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ç§˜å¯†éµã«ãƒã‚¤ãƒ³ãƒ‰ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ç›—é›£æ™‚ã®æ‚ªç”¨ã‚’é˜²ãã€‚

#### ä»•çµ„ã¿

```javascript
// 1. DPoP Proofã‚’ç”Ÿæˆ(ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨)
const dpopProof = jwt.sign({
  jti: uuid(),
  htm: 'GET',              // HTTPãƒ¡ã‚½ãƒƒãƒ‰
  htu: 'https://api.example.com/users',  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆURI
  iat: Date.now()
}, clientPrivateKey, {
  algorithm: 'ES256',
  header: { typ: 'dpop+jwt', jwk: clientPublicKeyJWK }
});

// 2. APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
fetch('https://api.example.com/users', {
  headers: {
    'Authorization': `DPoP ${accessToken}`,
    'DPoP': dpopProof
  }
});
```

#### ãƒ¡ãƒªãƒƒãƒˆ

- âœ… ãƒˆãƒ¼ã‚¯ãƒ³ãŒç›—ã¾ã‚Œã¦ã‚‚ç§˜å¯†éµãªã—ã§ã¯ä½¿ç”¨ä¸å¯
- âœ… ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒã®é˜²æ­¢
- âœ… ä¸­é–“è€…æ”»æ’ƒã¸ã®è€æ€§å‘ä¸Š

### 4. mTLS (Mutual TLS)

#### æ¦‚è¦

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã‚’ä½¿ã£ãŸç›¸äº’TLSèªè¨¼ã€‚

#### ç”¨é€”

- M2M(Machine-to-Machine)é€šä¿¡
- é«˜ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã®é‡‘èAPI(FAPIæº–æ‹ )
- ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°

```java
// Spring Boot ã§ã®mTLSè¨­å®š
@Configuration
public class MtlsConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        http
            .x509()
                .subjectPrincipalRegex("CN=(.*?)(?:,|$)")
                .userDetailsService(userDetailsService());

        return http.build();
    }
}
```

### 5. FAPI (Financial-grade API)

#### æ¦‚è¦

é‡‘èæ¥­ç•Œå‘ã‘ã®å³æ ¼ãªOAuth/OIDCå®Ÿè£…ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€‚

#### è¦ä»¶

- âœ… PARå¿…é ˆ
- âœ… JAR/JARMä½¿ç”¨
- âœ… DPoP ã¾ãŸã¯ mTLS ã«ã‚ˆã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
- âœ… çŸ­å¯¿å‘½ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³(æ¨å¥¨10åˆ†ä»¥ä¸‹)
- âœ… å³æ ¼ãªãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIæ¤œè¨¼
- âœ… state/nonceå¿…é ˆ

### 6. Shared Signals / CAEP (Continuous Access Evaluation Protocol)

#### æ¦‚è¦

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å…±æœ‰ã—ã€ç¶™ç¶šçš„ãªã‚¢ã‚¯ã‚»ã‚¹è©•ä¾¡ã‚’å®Ÿç¾ã€‚

#### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ â†’ å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–
- ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹æ¤œçŸ¥ â†’ è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨ãƒˆãƒ¼ã‚¯ãƒ³å–ã‚Šæ¶ˆã—
- ãƒ‡ãƒã‚¤ã‚¹ç´›å¤±å ±å‘Š â†’ è©²å½“ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦

```javascript
// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®å—ä¿¡
app.post('/security-events', (req, res) => {
  const event = req.body;

  if (event.type === 'session-revoked') {
    revokeUserSessions(event.subject);
  }

  res.status(202).send();
});
```

### 7. å…¸å‹çš„ãªè„…å¨ã¨å¯¾ç­–ã¾ã¨ã‚(2025å¹´ç‰ˆ)

| è„…å¨ | å¯¾ç­– |
|------|------|
| **ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°** | WebAuthn/ãƒ‘ã‚¹ã‚­ãƒ¼ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚° |
| **MFAç–²åŠ´æ”»æ’ƒ** | ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°è¡¨ç¤ºã€æ•°å€¤ãƒãƒƒãƒãƒ³ã‚° |
| **ãƒˆãƒ¼ã‚¯ãƒ³çªƒå–** | BFFã€DPoP/mTLSã€çŸ­å¯¿å‘½åŒ–ã€HttpOnly Cookie |
| **ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ—ãƒ¬ã‚¤** | DPoPã€nonceã€jti(JWT ID) |
| **XSS** | CSPã€Trusted Typesã€HttpOnly Cookieã€ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ¡ãƒ¢ãƒªã®ã¿ |
| **CSRF** | SameSite Cookieã€CSRFãƒˆãƒ¼ã‚¯ãƒ³ã€Origin/Refereræ¤œè¨¼ |
| **ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šåŒ–** | ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDå†ç”Ÿæˆ |
| **ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¹—ã£å–ã‚Š** | ãƒ‡ãƒã‚¤ã‚¹/IPç•°å¸¸æ¤œçŸ¥ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† |
| **ãƒŸãƒƒã‚¯ã‚¹ã‚¢ãƒƒãƒ—æ”»æ’ƒ** | issueræ¤œè¨¼ã€JARMã€stateæ¤œè¨¼ |
| **èªå¯ã‚³ãƒ¼ãƒ‰æ¨ªå–ã‚Š** | PKCEå¿…é ˆåŒ– |
| **ã‚ªãƒ¼ãƒ—ãƒ³ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ã‚¿** | ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIå³æ ¼ä¸€è‡´ã€ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ |

---

## Next.js + Spring Boot + AWS Cognitoæ§‹æˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³(2025å¹´ç‰ˆ - BFFãƒ‘ã‚¿ãƒ¼ãƒ³)

```mermaid
graph TB
    Browser[ãƒ–ãƒ©ã‚¦ã‚¶]
    NextJS[Next.js<br/>- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰UI<br/>- BFF Backend for Frontend<br/>- ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†]
    Cognito[AWS Cognito<br/>Identity Provider<br/>- èªè¨¼ãƒ»MFA<br/>- ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ<br/>- ãƒ‘ã‚¹ã‚­ãƒ¼å¯¾å¿œ]
    SpringBoot[Spring Boot API<br/>- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯<br/>- ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹<br/>- ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼]
    DB[ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹]

    Browser -->|â‘  Cookie(HttpOnly/Secure)| NextJS
    NextJS -->|â‘¡ Authorization Code + PKCE| Cognito
    Cognito -->|IDãƒˆãƒ¼ã‚¯ãƒ³/ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³| NextJS
    NextJS -->|â‘¢ Bearer Token| SpringBoot
    SpringBoot --> DB

    style NextJS fill:#e1f5ff
    style Cognito fill:#fff3e0
```

**é‡è¦**: ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯2025å¹´ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹(BFFã€PKCEã€ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookieéä¾å­˜)ã«æº–æ‹ ã—ã¦ã„ã¾ã™ã€‚

---

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ç‰¹å¾´

#### å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å½¹å‰²

**1. Next.js (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ + BFF)**

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹(React/SSR)
- èªè¨¼ãƒ•ãƒ­ãƒ¼ã®é–‹å§‹ãƒ»ç®¡ç†(Authorization Code + PKCE)
- Spring Boot APIã¸ã®ãƒ—ãƒ­ã‚­ã‚·(BFFãƒ‘ã‚¿ãƒ¼ãƒ³)
- ãƒˆãƒ¼ã‚¯ãƒ³ã®å®‰å…¨ãªç®¡ç†(ã‚µãƒ¼ãƒãƒ¼å´ã‚»ãƒƒã‚·ãƒ§ãƒ³)
- ãƒ–ãƒ©ã‚¦ã‚¶ã¨ã®é€šä¿¡ã¯HttpOnly Cookie(XSSå¯¾ç­–)

**2. AWS Cognito (IdP)**

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»èªè¨¼(ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã‚½ãƒ¼ã‚·ãƒ£ãƒ«)
- IDãƒˆãƒ¼ã‚¯ãƒ³ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œ
- MFA(å¤šè¦ç´ èªè¨¼)æä¾›: TOTPã€SMSã€WebAuthn/ãƒ‘ã‚¹ã‚­ãƒ¼
- ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³çµ±åˆ(Google, Facebookç­‰)
- ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–èªè¨¼(ç•°å¸¸æ¤œçŸ¥ã€ãƒªã‚¹ã‚¯ãƒ™ãƒ¼ã‚¹)

**3. Spring Boot (APIã‚µãƒ¼ãƒãƒ¼)**

- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ
- ãƒ‡ãƒ¼ã‚¿æ“ä½œ(CRUD)
- Cognitoãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼(JWTç½²åæ¤œè¨¼ã€issuer/audienceç¢ºèª)
- èªå¯åˆ¶å¾¡(ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡)
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š

---

### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹(2025å¹´ç‰ˆ)

#### 1. èªè¨¼ãƒ•ãƒ­ãƒ¼ã®å®Ÿè£…

**å¿…é ˆ: Authorization Code Flow with PKCE**

âŒ **Implicit Flowã¯ä½¿ç”¨ç¦æ­¢**(OAuth 2.1ã§å»ƒæ­¢)

âœ… **PKCE(Proof Key for Code Exchange)ã®åˆ©ç‚¹**:

- èªå¯ã‚³ãƒ¼ãƒ‰æ¨ªå–ã‚Šæ”»æ’ƒã‚’é˜²æ­¢
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆä¸è¦(SPAã§ã‚‚å®‰å…¨)
- ã™ã¹ã¦ã®OAuth 2.1å®Ÿè£…ã§å¿…é ˆåŒ–

**å®Ÿè£…æ‰‹é †**

**Step 1: Next.jsã§ã®èªè¨¼è¨­å®š(NextAuthä½¿ç”¨)**

```javascript
// pages/api/auth/[...nextauth].js
import NextAuth from 'next-auth';
import CognitoProvider from 'next-auth/providers/cognito';

export default NextAuth({
  providers: [
    CognitoProvider({
      clientId: process.env.COGNITO_CLIENT_ID,
      clientSecret: process.env.COGNITO_CLIENT_SECRET,
      issuer: process.env.COGNITO_ISSUER, // https://cognito-idp.{region}.amazonaws.com/{userPoolId}
      checks: ['pkce', 'state'], // PKCEã¨CSRFå¯¾ç­–
    })
  ],
  session: {
    strategy: 'jwt',
    maxAge: 30 * 24 * 60 * 60, // 30 days
  },
  callbacks: {
    async jwt({ token, account, profile }) {
      // Cognitoã‹ã‚‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
      if (account) {
        token.accessToken = account.access_token;
        token.idToken = account.id_token;
        token.refreshToken = account.refresh_token;
        token.sub = profile.sub;
      }
      return token;
    },
    async session({ session, token }) {
      // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ä½¿ç”¨ã™ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
      session.accessToken = token.accessToken;
      session.idToken = token.idToken;
      session.user.id = token.sub;
      return session;
    }
  },
  pages: {
    signIn: '/auth/signin',
    error: '/auth/error',
  }
});
```

**Step 2: APIå‘¼ã³å‡ºã—æ™‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ä»˜ä¸**

```javascript
// lib/apiClient.js
import { getSession } from 'next-auth/react';
import axios from 'axios';

export const apiClient = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL,
});

// BFFãƒ‘ã‚¿ãƒ¼ãƒ³: Next.js API Routeã‚’çµŒç”±
// pages/api/proxy/[...path].js
import { getServerSession } from "next-auth/next";
import { authOptions } from "../auth/[...nextauth]";

export default async function handler(req, res) {
  const session = await getServerSession(req, res, authOptions);

  if (!session) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  // Spring Bootã¸ãƒ—ãƒ­ã‚­ã‚·ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  const apiUrl = `${process.env.API_BASE_URL}${req.query.path.join('/')}`;

  try {
    const response = await fetch(apiUrl, {
      method: req.method,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${session.idToken}`, // IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡
      },
      body: req.method !== 'GET' ? JSON.stringify(req.body) : undefined,
    });

    const data = await response.json();
    res.status(response.status).json(data);
  } catch (error) {
    res.status(500).json({ error: 'API request failed' });
  }
}

// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ä½¿ç”¨ä¾‹
// components/UserProfile.jsx
import { useSession } from 'next-auth/react';
import { useEffect, useState } from 'react';

export default function UserProfile() {
  const { data: session } = useSession();
  const [profile, setProfile] = useState(null);

  useEffect(() => {
    if (session) {
      // BFFçµŒç”±ã§APIã«ã‚¢ã‚¯ã‚»ã‚¹
      fetch('/api/proxy/users/profile')
        .then(res => res.json())
        .then(data => setProfile(data));
    }
  }, [session]);

  if (!session) return <div>Please sign in</div>;

  return (
    <div>
      <h1>Welcome {session.user.name}</h1>
      {profile && <pre>{JSON.stringify(profile, null, 2)}</pre>}
    </div>
  );
}
```

**Step 3: Spring Bootã§ã®Cognitoãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼**

```java
// build.gradle
dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-oauth2-resource-server'
}

// application.yml
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: https://cognito-idp.ap-northeast-1.amazonaws.com/${COGNITO_USER_POOL_ID}
          jwk-set-uri: https://cognito-idp.ap-northeast-1.amazonaws.com/${COGNITO_USER_POOL_ID}/.well-known/jwks.json

// SecurityConfig.java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable()) // JWTä½¿ç”¨æ™‚
            .cors(cors -> cors.configurationSource(corsConfigurationSource()))
            .sessionManagement(session ->
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/health", "/actuator/**").permitAll()
                .anyRequest().authenticated()
            )
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt(jwt -> jwt
                    .jwtAuthenticationConverter(jwtAuthenticationConverter())
                )
            );

        return http.build();
    }

    @Bean
    public JwtAuthenticationConverter jwtAuthenticationConverter() {
        JwtAuthenticationConverter converter = new JwtAuthenticationConverter();

        // Cognitoã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãƒ­ãƒ¼ãƒ«ã«å¤‰æ›
        JwtGrantedAuthoritiesConverter authoritiesConverter =
            new JwtGrantedAuthoritiesConverter();
        authoritiesConverter.setAuthoritiesClaimName("cognito:groups");
        authoritiesConverter.setAuthorityPrefix("ROLE_");

        converter.setJwtGrantedAuthoritiesConverter(authoritiesConverter);
        return converter;
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(
            Arrays.asList(
                "http://localhost:3000",  // é–‹ç™ºç’°å¢ƒ
                "https://your-app.com"     // æœ¬ç•ªç’°å¢ƒ
            )
        );
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
        configuration.setAllowedHeaders(Arrays.asList("*"));
        configuration.setAllowCredentials(true);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
}

// ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§ã®ä½¿ç”¨ä¾‹
@RestController
@RequestMapping("/api/users")
public class UserController {

    @GetMapping("/profile")
    public ResponseEntity<UserProfile> getProfile(
        @AuthenticationPrincipal Jwt jwt
    ) {
        String userId = jwt.getSubject(); // Cognito User ID
        String email = jwt.getClaim("email");
        List<String> groups = jwt.getClaim("cognito:groups");

        UserProfile profile = userService.getProfile(userId);
        return ResponseEntity.ok(profile);
    }

    @PreAuthorize("hasRole('Admin')")
    @GetMapping("/admin")
    public ResponseEntity<List<User>> getAllUsers() {
        return ResponseEntity.ok(userService.getAllUsers());
    }
}
```

---

#### 2. ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†æˆ¦ç•¥(2025å¹´ç‰ˆ)

**IDãƒˆãƒ¼ã‚¯ãƒ³ vs ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ vs ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³**

| ãƒˆãƒ¼ã‚¯ãƒ³ | ç”¨é€” | é€ä¿¡å…ˆ | æœ‰åŠ¹æœŸé™ | ä¿å­˜å ´æ‰€(BFF) |
|---------|------|--------|---------|--------------|
| IDãƒˆãƒ¼ã‚¯ãƒ³ | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€APIèªè¨¼ | Spring Boot API | 1æ™‚é–“ | Next.jsã‚µãƒ¼ãƒãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ |
| ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ | Cognito User Pool API | AWS Cognito | 1æ™‚é–“ | Next.jsã‚µãƒ¼ãƒãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ |
| ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ | ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–° | AWS Cognito | 30æ—¥ | Next.jsã‚µãƒ¼ãƒãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ |

**BFFãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…(æ¨å¥¨)**

Next.jsã‚’BFF(Backend for Frontend)ã¨ã—ã¦ä½¿ç”¨ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç®¡ç†:

```javascript
// middleware.ts (Next.js 13+)
import { withAuth } from "next-auth/middleware";

export default withAuth({
  callbacks: {
    authorized({ token }) {
      return !!token;
    },
  },
});

export const config = {
  matcher: [
    '/dashboard/:path*',
    '/api/proxy/:path*',
  ],
};
```

**ãƒ¡ãƒªãƒƒãƒˆ**:

- âœ… ãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒ–ãƒ©ã‚¦ã‚¶ã«å…¬é–‹ã•ã‚Œãªã„(XSSå¯¾ç­–)
- âœ… CORSè¨­å®šãŒã‚·ãƒ³ãƒ—ãƒ«(Next.js â†” Spring Bootã®ã¿)
- âœ… ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§åˆ¶å¾¡
- âœ… Next.jsã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯èƒ½
- âœ… ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookieå•é¡Œã‚’å›é¿(2025å¹´ã®å¿…é ˆå¯¾å¿œ)
- âœ… ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®‰å…¨ã«å®Ÿè£…å¯èƒ½

**ã‚»ãƒƒã‚·ãƒ§ãƒ³ vs JWTæˆ¦ç•¥**:

```javascript
// NextAuthè¨­å®š
session: {
  strategy: 'jwt',  // æ¨å¥¨: ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«
  // strategy: 'database',  // ä»£æ›¿: ã‚ˆã‚Šå³æ ¼ãªç®¡ç†ãŒå¿…è¦ãªå ´åˆ
  maxAge: 30 * 24 * 60 * 60, // 30æ—¥
}
```

---

#### 3. AWS Cognitoè¨­å®šã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹(2025å¹´ç‰ˆ)

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«è¨­å®š**

```terraform
# Terraformä¾‹
resource "aws_cognito_user_pool" "main" {
  name = "your-app-user-pool"

  # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼(NIST 800-63Bæº–æ‹ )
  password_policy {
    minimum_length    = 12  # æœ€å°12æ–‡å­—æ¨å¥¨(2025å¹´)
    require_lowercase = true
    require_uppercase = true
    require_numbers   = true
    require_symbols   = true
    temporary_password_validity_days = 1
  }

  # MFAè¨­å®š
  mfa_configuration = "OPTIONAL"  # "ON"ã§å¿…é ˆåŒ–ã‚‚å¯èƒ½

  software_token_mfa_configuration {
    enabled = true  # TOTP(Google Authenticatorç­‰)
  }

  # WebAuthn/ãƒ‘ã‚¹ã‚­ãƒ¼å¯¾å¿œ(2024å¹´ä»¥é™å¯¾å¿œ)
  # user_pool_add_ons {
  #   advanced_security_mode = "ENFORCED"  # ã“ã‚Œã§æœ‰åŠ¹åŒ–
  # }

  # ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå›å¾©
  account_recovery_setting {
    recovery_mechanism {
      name     = "verified_email"
      priority = 1
    }
    # recovery_mechanism {
    #   name     = "verified_phone_number"  # ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    #   priority = 2
    # }
  }

  # å±æ€§æ¤œè¨¼
  auto_verified_attributes = ["email"]

  # ãƒ¡ãƒ¼ãƒ«è¨­å®š(SESã‚’ä½¿ç”¨æ¨å¥¨ - é€ä¿¡åˆ¶é™å›é¿)
  email_configuration {
    email_sending_account = "DEVELOPER"
    source_arn           = aws_ses_email_identity.main.arn
    reply_to_email_address = "noreply@example.com"
  }

  # ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§
  schema {
    name                = "email"
    attribute_data_type = "String"
    required            = true
    mutable             = true
  }

  # Lambda Trigger(ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º)
  lambda_config {
    pre_authentication       = aws_lambda_function.pre_auth.arn
    post_authentication      = aws_lambda_function.post_auth.arn
    pre_token_generation     = aws_lambda_function.pre_token.arn
    custom_message          = aws_lambda_function.custom_message.arn
  }

  # ãƒ‡ãƒã‚¤ã‚¹è¨˜æ†¶(ä¿¡é ¼æ¸ˆã¿ãƒ‡ãƒã‚¤ã‚¹ç®¡ç†)
  device_configuration {
    challenge_required_on_new_device      = true
    device_only_remembered_on_user_prompt = true
  }
}

# ã‚¢ãƒ—ãƒªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š(2025å¹´ç‰ˆ - OAuth 2.1æº–æ‹ )
resource "aws_cognito_user_pool_client" "nextjs" {
  name         = "nextjs-client"
  user_pool_id = aws_cognito_user_pool.main.id

  # âŒ Implicitãƒ•ãƒ­ãƒ¼ã¯ä½¿ç”¨ç¦æ­¢
  # âœ… Authorization Codeã®ã¿è¨±å¯
  allowed_oauth_flows                  = ["code"]
  allowed_oauth_flows_user_pool_client = true
  allowed_oauth_scopes                 = ["openid", "email", "profile", "aws.cognito.signin.user.admin"]

  # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URL(å³æ ¼ãªä¸€è‡´å¿…é ˆ)
  callback_urls = [
    "http://localhost:3000/api/auth/callback/cognito",  # é–‹ç™º
    "https://your-app.com/api/auth/callback/cognito"    # æœ¬ç•ª
  ]

  logout_urls = [
    "http://localhost:3000",
    "https://your-app.com"
  ]

  # ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™(2025å¹´æ¨å¥¨)
  access_token_validity  = 1   # 1æ™‚é–“(çŸ­å¯¿å‘½æ¨å¥¨)
  id_token_validity      = 1   # 1æ™‚é–“
  refresh_token_validity = 30  # 30æ—¥

  token_validity_units {
    access_token  = "hours"
    id_token      = "hours"
    refresh_token = "days"
  }

  # PKCEã‚µãƒãƒ¼ãƒˆ(å¿…é ˆ)
  explicit_auth_flows = [
    "ALLOW_REFRESH_TOKEN_AUTH",
    "ALLOW_USER_SRP_AUTH",        # Secure Remote Password
    # "ALLOW_CUSTOM_AUTH"          # ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ãƒ•ãƒ­ãƒ¼ç”¨
  ]

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
  prevent_user_existence_errors = "ENABLED"  # ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ—æŒ™æ”»æ’ƒå¯¾ç­–

  # ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³(2025å¹´æ¨å¥¨)
  enable_token_revocation = true

  # Read/Writeå±æ€§ã®åˆ¶å¾¡
  read_attributes  = ["email", "email_verified", "name"]
  write_attributes = ["name"]
}

# ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š(ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³æ¨å¥¨)
resource "aws_cognito_user_pool_domain" "main" {
  domain       = "auth"
  user_pool_id = aws_cognito_user_pool.main.id
  certificate_arn = aws_acm_certificate.auth.arn  # ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ç”¨
}
```

**é‡è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š(2025å¹´ç‰ˆ)**

1. **Advanced Security Features(å¿…é ˆ)**

```terraform
resource "aws_cognito_user_pool" "main" {
  # é«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½
  user_pool_add_ons {
    advanced_security_mode = "ENFORCED"  # AUDIT or ENFORCED
  }
}
```

æ©Ÿèƒ½:

- âœ… **ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–èªè¨¼**: ç•°å¸¸ãªãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œçŸ¥
- âœ… **æ¼æ´©ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥**: æ—¢çŸ¥ã®æ¼æ´©ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯
- âœ… **ãƒªã‚¹ã‚¯ãƒ™ãƒ¼ã‚¹MFA**: ãƒªã‚¹ã‚¯ã«å¿œã˜ã¦è‡ªå‹•ã§MFAè¦æ±‚

2. **WAFçµ±åˆ(æ¨å¥¨)**

```terraform
# Cognito Hosted UIã‚’WAFã§ä¿è­·
resource "aws_wafv2_web_acl_association" "cognito" {
  resource_arn = aws_cognito_user_pool.main.arn
  web_acl_arn  = aws_wafv2_web_acl.main.arn
}
```

3. **ãƒ­ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°**

```terraform
# CloudWatch Logsã¸ã®å‡ºåŠ›
resource "aws_cloudwatch_log_group" "cognito" {
  name              = "/aws/cognito/${aws_cognito_user_pool.main.name}"
  retention_in_days = 30
}
```

---

#### 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ

**ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œå¯¾å¿œ**

```javascript
// Next.js API Route
// pages/api/proxy/[...path].js
export default async function handler(req, res) {
  const session = await getServerSession(req, res, authOptions);

  if (!session) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  try {
    const response = await fetch(apiUrl, {
      headers: {
        'Authorization': `Bearer ${session.idToken}`,
      },
    });

    if (response.status === 401) {
      // ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥è©¦è¡Œ
      const refreshed = await refreshCognitoToken(session.refreshToken);

      if (refreshed) {
        // å†è©¦è¡Œ
        const retryResponse = await fetch(apiUrl, {
          headers: {
            'Authorization': `Bearer ${refreshed.idToken}`,
          },
        });
        return res.status(retryResponse.status).json(await retryResponse.json());
      } else {
        // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¤±æ•—ã€å†ãƒ­ã‚°ã‚¤ãƒ³å¿…è¦
        return res.status(401).json({ error: 'Session expired' });
      }
    }

    return res.status(response.status).json(await response.json());
  } catch (error) {
    console.error('API Error:', error);
    return res.status(500).json({ error: 'Internal server error' });
  }
}
```

**ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Ÿè£…**

```javascript
// Cognitoã‹ã‚‰ã‚‚ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
import { signOut } from 'next-auth/react';

const handleLogout = async () => {
  // NextAuthã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
  await signOut({
    callbackUrl: '/login',
    redirect: true
  });

  // Cognito Hosted UIã‹ã‚‰ã‚‚ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ(ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
  const cognitoDomain = process.env.NEXT_PUBLIC_COGNITO_DOMAIN;
  const clientId = process.env.NEXT_PUBLIC_COGNITO_CLIENT_ID;
  const logoutUri = encodeURIComponent(window.location.origin);

  window.location.href =
    `${cognitoDomain}/logout?client_id=${clientId}&logout_uri=${logoutUri}`;
};
```

---

#### 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ(2025å¹´ç‰ˆ)

**Next.jså´**

- [ ] ç’°å¢ƒå¤‰æ•°ã®é©åˆ‡ãªç®¡ç†(.env.localã€AWS Secrets Manager)
- [ ] HTTPSé€šä¿¡ã®å¼·åˆ¶(æœ¬ç•ªç’°å¢ƒ)
- [ ] Content Security Policyè¨­å®š(CSP)
- [ ] PKCEæœ‰åŠ¹åŒ–(å¿…é ˆ)
- [ ] state ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§CSRFå¯¾ç­–(å¿…é ˆ)
- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š(ã‚¢ã‚¤ãƒ‰ãƒ«+çµ¶å¯¾)
- [ ] BFFãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚µãƒ¼ãƒãƒ¼å´ç®¡ç†
- [ ] Cookieå±æ€§: HttpOnly, Secure, SameSite=Strict
- [ ] ä¾å­˜é–¢ä¿‚ã®å®šæœŸæ›´æ–°(npm audit)
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼: HSTS, X-Frame-Optionsç­‰

**Spring Bootå´**

- [ ] JWTãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã®å®Ÿè£…(ç½²åã€issuerã€audienceã€exp)
- [ ] CORSã®é©åˆ‡ãªè¨­å®š(ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ç¦æ­¢ã€Originãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ)
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¨­å®š
- [ ] ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡(@PreAuthorize)
- [ ] APIãƒ¬ãƒ¼ãƒˆåˆ¶é™(Bucket4jç­‰)
- [ ] ãƒ­ã‚°ãƒ»ç›£æŸ»è¨¼è·¡ã®è¨˜éŒ²(CloudWatch Logs)
- [ ] å…¥åŠ›å€¤ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚µãƒ‹ã‚¿ã‚¤ã‚º
- [ ] SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–(PreparedStatement)
- [ ] JWKSã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°(ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹)
- [ ] ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°(è©³ç´°æƒ…å ±ã®æ¼ãˆã„é˜²æ­¢)

**AWS Cognitoå´**

- [ ] å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼(12æ–‡å­—ä»¥ä¸Š)
- [ ] MFAæœ‰åŠ¹åŒ–(TOTP/WebAuthnæ¨å¥¨ã€SMSéæ¨å¥¨)
- [ ] Advanced Security Featuresæœ‰åŠ¹åŒ–(ENFORCED)
- [ ] é©åˆ‡ãªãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™(ã‚¢ã‚¯ã‚»ã‚¹1æ™‚é–“ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥30æ—¥)
- [ ] Lambdaãƒˆãƒªã‚¬ãƒ¼ã§ã®ã‚«ã‚¹ã‚¿ãƒ æ¤œè¨¼
- [ ] CloudWatch Logsã§ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
- [ ] WAFçµ±åˆ(DDoSã€ãƒœãƒƒãƒˆå¯¾ç­–)
- [ ] ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIå³æ ¼ä¸€è‡´(å®Œå…¨ä¸€è‡´ã®ã¿)
- [ ] prevent_user_existence_errorsæœ‰åŠ¹åŒ–
- [ ] ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ä½¿ç”¨(auth.your-app.com)
- [ ] SESçµ±åˆ(ãƒ¡ãƒ¼ãƒ«é€ä¿¡åˆ¶é™å›é¿)
- [ ] ãƒ‡ãƒã‚¤ã‚¹è¨˜æ†¶æ©Ÿèƒ½ã®æ´»ç”¨

**é‹ç”¨ãƒ»ç›£è¦–**

- [ ] ç•°å¸¸ãªãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œçŸ¥ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ
- [ ] ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œè¨ˆç”»
- [ ] å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
- [ ] ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿæ–½
- [ ] OWASP Top 10å¯¾ç­–ã®ç¢ºèª
- [ ] GDPR/å€‹äººæƒ…å ±ä¿è­·æ³•å¯¾å¿œ
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚«ãƒãƒªãƒ¼æ‰‹é †ã®æ•´å‚™

---

#### 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

**1. ãƒˆãƒ¼ã‚¯ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°**

```java
// Spring Boot: JWK Set ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
@Configuration
public class JwtDecoderConfig {

    @Bean
    public JwtDecoder jwtDecoder() {
        String jwkSetUri = "https://cognito-idp.ap-northeast-1.amazonaws.com/"
                         + userPoolId + "/.well-known/jwks.json";

        NimbusJwtDecoder jwtDecoder = NimbusJwtDecoder
            .withJwkSetUri(jwkSetUri)
            .cache(Caffeine.newBuilder()  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¿½åŠ 
                .maximumSize(100)
                .expireAfterWrite(10, TimeUnit.MINUTES)
                .build())
            .build();

        return jwtDecoder;
    }
}
```

**2. BFFã§ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥**

```javascript
// Next.js API Route with cache
export const config = {
  runtime: 'edge',
};

export default async function handler(req) {
  const session = await getServerSession(req);

  if (!session) {
    return new Response('Unauthorized', { status: 401 });
  }

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
  const response = await fetch(apiUrl, {
    headers: {
      'Authorization': `Bearer ${session.idToken}`,
    },
    next: { revalidate: 60 } // 60ç§’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  });

  return response;
}
```

---

#### 7. é–‹ç™ºãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

**ç’°å¢ƒåˆ†é›¢**

```bash
# é–‹ç™ºç’°å¢ƒ
COGNITO_USER_POOL_ID=ap-northeast-1_dev
COGNITO_CLIENT_ID=dev_client_id
API_BASE_URL=http://localhost:8080

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ
COGNITO_USER_POOL_ID=ap-northeast-1_stg
COGNITO_CLIENT_ID=stg_client_id
API_BASE_URL=https://api-stg.your-app.com

# æœ¬ç•ªç’°å¢ƒ
COGNITO_USER_POOL_ID=ap-northeast-1_prod
COGNITO_CLIENT_ID=prod_client_id
API_BASE_URL=https://api.your-app.com
```

**CI/CDã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ä¾‹**

```yaml
# GitHub Actions
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy-nextjs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}

  deploy-spring-boot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy to AWS ECS
        # ... ECS deployment steps
```

---

### ã¾ã¨ã‚: Next.js + Spring Boot + Cognito æ§‹æˆã®ãƒã‚¤ãƒ³ãƒˆ(2025å¹´ç‰ˆ)

#### âœ… ã“ã®æ§‹æˆãŒå„ªã‚Œã¦ã„ã‚‹ç†ç”±

1. **2025å¹´ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹æº–æ‹ **
   - BFFãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†(ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookieéä¾å­˜)
   - Authorization Code + PKCE(OAuth 2.1æº–æ‹ )
   - ãƒ‘ã‚¹ã‚­ãƒ¼/WebAuthnå¯¾å¿œå¯èƒ½
   - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

2. **è²¬å‹™ã®åˆ†é›¢**
   - Next.js: UI/UXã€BFFã€ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
   - Cognito: èªè¨¼åŸºç›¤ã€MFAã€ãƒªã‚¹ã‚¯ãƒ™ãƒ¼ã‚¹èªè¨¼
   - Spring Boot: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€èªå¯åˆ¶å¾¡

3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
   - ãƒˆãƒ¼ã‚¯ãƒ³ã‚’Next.jsã‚µãƒ¼ãƒãƒ¼å´ã§ç®¡ç†(XSSå¯¾ç­–)
   - HttpOnly/Secure/SameSite Cookie(CSRFå¯¾ç­–)
   - Cognitoã«ã‚ˆã‚‹å …ç‰¢ãªèªè¨¼(Advanced Security)
   - æ¨™æº–ãƒ—ãƒ­ãƒˆã‚³ãƒ«(OAuth 2.0/OIDC)æº–æ‹ 
   - WAF/CloudWatchçµ±åˆã§é˜²å¾¡ã¨ç›£è¦–

4. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**
   - ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹è¨­è¨ˆ(JWTæˆ¦ç•¥)
   - ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹(Cognito)æ´»ç”¨
   - ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹åŒ–ã‚‚å®¹æ˜“
   - æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å¯¾å¿œ

5. **é–‹ç™ºåŠ¹ç‡**
   - NextAuth/Auth.jsã§ç°¡å˜çµ±åˆ
   - Spring Securityã®OAuth2è‡ªå‹•è¨­å®š
   - AWS CDK/Terraformã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ãƒ¼ãƒ‰åŒ–
   - è±Šå¯Œãªã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¨ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£

#### âš ï¸ æ³¨æ„ã™ã¹ãè½ã¨ã—ç©´

1. **ã‚³ã‚¹ãƒˆ**: Cognitoã®æ–™é‡‘ä½“ç³»(MAUèª²é‡‘ã€50,000 MAUã¾ã§ç„¡æ–™)
2. **ãƒ­ãƒƒã‚¯ã‚¤ãƒ³**: AWSä¾å­˜åº¦ãŒé«˜ã„(ç§»è¡Œã‚³ã‚¹ãƒˆ)
3. **è¤‡é›‘æ€§**: 3å±¤æ§‹é€ ã®ãƒ‡ãƒãƒƒã‚°ã®é›£ã—ã•ã€åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°å¿…é ˆ
4. **ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·**: BFFçµŒç”±ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰(ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥ã§ç·©å’Œ)
5. **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åˆ¶ç´„**: Cognitoã®ä¸€éƒ¨æ©Ÿèƒ½ãŒãƒªãƒ¼ã‚¸ãƒ§ãƒ³é™å®š
6. **ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºé™ç•Œ**: Cognito Hosted UIã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºåˆ¶ç´„

#### ğŸš€ æ¨å¥¨ã•ã‚Œã‚‹æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**:

1. PAR/JAR/JARMã®å°å…¥æ¤œè¨(é«˜ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶æ™‚)
2. DPoPã«ã‚ˆã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
3. Shared Signals/CAEPã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
4. FedCMå¯¾å¿œ(å°†æ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–)

**é‹ç”¨æ”¹å–„**:
5. Cognitoã®ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’æ´»ç”¨ã—ãŸç´°ã‹ã„æ¨©é™åˆ¶å¾¡
6. Cognitoã‚°ãƒ«ãƒ¼ãƒ—æ©Ÿèƒ½ã§ãƒ­ãƒ¼ãƒ«ç®¡ç†(RBAC)
7. AWS WAF + Shield Advancedã§ DDoSå¯¾ç­–
8. CloudWatch/X-Ray/OpenTelemetryã§ç›£è¦–ãƒ»ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°
9. Chaos Engineering/éšœå®³ãƒ†ã‚¹ãƒˆ

**UXæ”¹å–„**:
10. ãƒ‘ã‚¹ã‚­ãƒ¼(WebAuthn)ã®ç©æ¥µå°å…¥
11. ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–èªè¨¼ã«ã‚ˆã‚‹ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªMFA
12. ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³æ‹¡å……
13. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªãƒ³ã‚¯æ©Ÿèƒ½(è¤‡æ•°IdPçµ±åˆ)

**é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹**:
14. E2Eãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–(Playwright/Cypress + Cognito Local)
15. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–(OWASP ZAP)
16. CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å¼·åŒ–
17. ãƒ–ãƒ«ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤/ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹

---

## å‚è€ƒãƒªã‚½ãƒ¼ã‚¹

### æ¨™æº–ä»•æ§˜ãƒ»RFC

- [OAuth 2.0 RFC 6749](https://datatracker.ietf.org/doc/html/rfc6749)
- [OAuth 2.1 Draft](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-10)
- [PKCE RFC 7636](https://datatracker.ietf.org/doc/html/rfc7636)
- [OpenID Connect Core 1.0](https://openid.net/specs/openid-connect-core-1_0.html)
- [DPoP RFC 9449](https://datatracker.ietf.org/doc/html/rfc9449)
- [PAR RFC 9126](https://datatracker.ietf.org/doc/html/rfc9126)

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [NIST 800-63B Digital Identity Guidelines](https://pages.nist.gov/800-63-3/sp800-63b.html)
- [FAPI Security Profile](https://openid.net/specs/openid-financial-api-part-2-1_0.html)
- [OAuth 2.0 Security Best Current Practice](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics)

### ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- [NextAuth.js / Auth.js Documentation](https://next-auth.js.org/)
- [Spring Security OAuth 2.0](https://spring.io/guides/tutorials/spring-boot-oauth2)
- [AWS Cognito Developer Guide](https://docs.aws.amazon.com/cognito/latest/developerguide/)
- [WebAuthn Guide](https://webauthn.guide/)

### æœ€æ–°æƒ…å ±

- [OAuth Working Group](https://datatracker.ietf.org/wg/oauth/documents/)
- [OpenID Foundation](https://openid.net/)
- [FedCM (Federated Credential Management)](https://fedidcg.github.io/FedCM/)

---

## 2025å¹´ã®èªè¨¼å®Ÿè£…ã¾ã¨ã‚

### æœ€é‡è¦ãƒã‚¤ãƒ³ãƒˆ

1. **BFFãƒ‘ã‚¿ãƒ¼ãƒ³ + Authorization Code + PKCE** ãŒå®Ÿå‹™ä¸Šã®å®‰å®šè§£
2. **ãƒ‘ã‚¹ã‚­ãƒ¼(WebAuthn)** ã‚’ç¬¬ä¸€é¸æŠã®MFAã«
3. **Implicit Flow / ROPC ã¯ä½¿ç”¨ç¦æ­¢** (OAuth 2.1ã§å»ƒæ­¢)
4. **ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookieéä¾å­˜** ã®è¨­è¨ˆ(FedCMæ¤œè¨)
5. **ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³** å¿…é ˆ
6. **ãƒˆãƒ¼ã‚¯ãƒ³çŸ­å¯¿å‘½åŒ– + ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°**(DPoP/mTLS)
7. **ãƒªã‚¹ã‚¯ãƒ™ãƒ¼ã‚¹/ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–èªè¨¼** ã§UXã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸¡ç«‹

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é¸æŠã®æŒ‡é‡

| ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ | æ¨å¥¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | èªè¨¼æ–¹å¼ |
|------------|------------------|---------|
| ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¢ãƒ—ãƒª | Next.js SSR | ã‚»ãƒƒã‚·ãƒ§ãƒ³ + OIDC |
| SPA + API | **BFFãƒ‘ã‚¿ãƒ¼ãƒ³** | Authorization Code + PKCE |
| ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒª | ãƒã‚¤ãƒ†ã‚£ãƒ– + API | Authorization Code + PKCE (ã‚·ã‚¹ãƒ†ãƒ ãƒ–ãƒ©ã‚¦ã‚¶) |
| ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚º | SSOçµ±åˆ | OIDC / SAML 2.0 |
| M2M | APIé–“é€šä¿¡ | Client Credentials + mTLS |

### ãƒ¬ã‚¬ã‚·ãƒ¼ã‹ã‚‰ã®ç§»è¡Œ

å¾“æ¥ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã‚„Implicit Flowä½¿ç”¨ã‚¢ãƒ—ãƒªã¯ã€ä»¥ä¸‹ã®æ®µéšçš„ç§»è¡Œã‚’æ¨å¥¨:

1. **Phase 1**: PKCEè¿½åŠ ã€state/nonceå¿…é ˆåŒ–
2. **Phase 2**: BFFãƒ‘ã‚¿ãƒ¼ãƒ³å°å…¥ã€ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã®ã‚µãƒ¼ãƒãƒ¼å´ç§»è¡Œ
3. **Phase 3**: ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
4. **Phase 4**: WebAuthn/ãƒ‘ã‚¹ã‚­ãƒ¼å°å…¥
5. **Phase 5**: PAR/DPoPç­‰ã®é«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½è¿½åŠ 

---

**ä½œæˆæ—¥**: 2025å¹´10æœˆ15æ—¥
**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ15æ—¥
**å¯¾è±¡èª­è€…**: Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºåˆå¿ƒè€…ã€œä¸­ç´šè€…
**æƒ³å®šæ§‹æˆ**: Next.js + Spring Boot + AWS Cognito
**æº–æ‹ æ¨™æº–**: OAuth 2.1, OIDC, NIST 800-63B, OWASP

---

<sub>**[ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰]**

Webèªè¨¼ 2025, BFFãƒ‘ã‚¿ãƒ¼ãƒ³, OAuth 2.1, PKCE, ãƒ‘ã‚¹ã‚­ãƒ¼, WebAuthn, ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookie, DPoP, ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³, Next.jsèªè¨¼, AWS Cognito, Spring Security, OIDC, ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</sub>
